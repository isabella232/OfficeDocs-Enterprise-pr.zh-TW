---
title: Microsoft Azure 中的 SharePoint Server 2013 災害復原
ms.author: bcarter
author: brendacarter
manager: laurawi
ms.date: 04/17/2018
audience: ITPro
ms.topic: article
ms.service: o365-solutions
localization_priority: Normal
search.appverid:
- MET150
ms.collection: Ent_O365
f1.keywords:
- CSH
ms.custom: Ent_Deployment
ms.assetid: e9d14cb2-ff28-4a18-a444-cebf891880ea
description: 摘要：使用 Azure，您可以為內部部署 SharePoint 伺服器陣列建立災害復原環境。 本文說明如何設計和實作本解決方案。
ms.openlocfilehash: 101d87b1a25d2b3ac8a7ae29832e52c805ecdc4c
ms.sourcegitcommit: 6e608d957082244d1b4ffb47942e5847ec18c0b9
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/01/2020
ms.locfileid: "44998165"
---
# <a name="sharepoint-server-2013-disaster-recovery-in-microsoft-azure"></a><span data-ttu-id="5ae63-104">Microsoft Azure 中的 SharePoint Server 2013 災害復原</span><span class="sxs-lookup"><span data-stu-id="5ae63-104">SharePoint Server 2013 Disaster Recovery in Microsoft Azure</span></span>

 <span data-ttu-id="5ae63-105">使用 Azure，您可以為內部部署 SharePoint 伺服器陣列建立災害復原環境。</span><span class="sxs-lookup"><span data-stu-id="5ae63-105">Using Azure, you can create a disaster-recovery environment for your on-premises SharePoint farm.</span></span> <span data-ttu-id="5ae63-106">本文說明如何設計和實作本解決方案。</span><span class="sxs-lookup"><span data-stu-id="5ae63-106">This article describes how to design and implement this solution.</span></span>

 <span data-ttu-id="5ae63-107">**觀賞 SharePoint Server 2013 嚴重損壞恢復概述影片**</span><span class="sxs-lookup"><span data-stu-id="5ae63-107">**Watch the SharePoint Server 2013 disaster recovery overview video**</span></span>
> [!VIDEO https://www.microsoft.com/videoplayer/embed/1b73ec8f-29bd-44eb-aa3a-f7932784bfd9?autoplay=false]
  
 <span data-ttu-id="5ae63-108">當發生災難時，您的 SharePoint 內部部署環境，您的最高優先順序是讓系統立即重新執行。</span><span class="sxs-lookup"><span data-stu-id="5ae63-108">When disaster strikes your SharePoint on-premises environment, your top priority is to get the system running again quickly.</span></span> <span data-ttu-id="5ae63-109">當您有備份環境已在 Microsoft Azure 中執行時，具有 SharePoint 的嚴重損壞復原會變得更快且更容易。</span><span class="sxs-lookup"><span data-stu-id="5ae63-109">Disaster recovery with SharePoint is quicker and easier when you have a backup environment already running in Microsoft Azure.</span></span> <span data-ttu-id="5ae63-110">這段影片說明 SharePoint 溫容錯移轉環境的主要概念，並補充本文中提供的完整詳細資料。</span><span class="sxs-lookup"><span data-stu-id="5ae63-110">This video explains the main concepts of a SharePoint warm failover environment and complements the full details available in this article.</span></span>
  
<span data-ttu-id="5ae63-111">請使用本文搭配下列解決方案模型：**在 Microsoft Azure 中 SharePoint 災難修復**。</span><span class="sxs-lookup"><span data-stu-id="5ae63-111">Use this article with the following solution model: **SharePoint Disaster Recovery in Microsoft Azure**.</span></span>
  
<span data-ttu-id="5ae63-112">[![SharePoint 到 Azure 的災害復原程序](media/SP-DR-Azure.png)](https://go.microsoft.com/fwlink/p/?LinkId=392555)</span><span class="sxs-lookup"><span data-stu-id="5ae63-112">[![SharePoint disaster-recovery process to Azure](media/SP-DR-Azure.png)](https://go.microsoft.com/fwlink/p/?LinkId=392555)</span></span>
  
 <span data-ttu-id="5ae63-113">[PDF](https://go.microsoft.com/fwlink/p/?LinkId=392555) |  [Visio](https://go.microsoft.com/fwlink/p/?LinkId=392554)</span><span class="sxs-lookup"><span data-stu-id="5ae63-113">[PDF](https://go.microsoft.com/fwlink/p/?LinkId=392555) |  [Visio](https://go.microsoft.com/fwlink/p/?LinkId=392554)</span></span>
  
## <a name="use-azure-infrastructure-services-for-disaster-recovery"></a><span data-ttu-id="5ae63-114">使用 Azure 基礎結構服務進行嚴重損壞修復</span><span class="sxs-lookup"><span data-stu-id="5ae63-114">Use Azure Infrastructure Services for disaster recovery</span></span>

<span data-ttu-id="5ae63-115">許多組織沒有 SharePoint 的嚴重損壞復原環境，因此建立及維護內部部署成本可能很高。</span><span class="sxs-lookup"><span data-stu-id="5ae63-115">Many organizations do not have a disaster recovery environment for SharePoint, which can be expensive to build and maintain on-premises.</span></span> <span data-ttu-id="5ae63-116">Azure 基礎結構服務為嚴重損壞復原環境提供了極具說服力的選項，其可比內部部署方案更靈活且成本低。</span><span class="sxs-lookup"><span data-stu-id="5ae63-116">Azure Infrastructure Services provides compelling options for disaster recovery environments that are more flexible and less expensive than the on-premises alternatives.</span></span>
  
<span data-ttu-id="5ae63-117">使用 Azure 基礎結構服務的優點包括：</span><span class="sxs-lookup"><span data-stu-id="5ae63-117">The advantages for using Azure Infrastructure Services include:</span></span>
  
- <span data-ttu-id="5ae63-118">**成本較低的資源**維護和支付的資源少於內部部署的嚴重損壞修復環境。</span><span class="sxs-lookup"><span data-stu-id="5ae63-118">**Fewer costly resources** Maintain and pay for fewer resources than on-premises disaster recovery environments.</span></span> <span data-ttu-id="5ae63-119">資源數目取決於您所選擇的嚴重損壞復原環境：冷待命、暖色待命或熱待機。</span><span class="sxs-lookup"><span data-stu-id="5ae63-119">The number of resources depends on which disaster-recovery environment you choose: cold standby, warm standby, or hot standby.</span></span>
    
- <span data-ttu-id="5ae63-120">**更好的資源彈性**萬一發生嚴重損壞，請輕鬆擴充您的復原 SharePoint 伺服器陣列，以滿足負載需求。</span><span class="sxs-lookup"><span data-stu-id="5ae63-120">**Better resource flexibility** In the event of a disaster, easily scale out your recovery SharePoint farm to meet load requirements.</span></span> <span data-ttu-id="5ae63-121">當您不再需要資源時放大。</span><span class="sxs-lookup"><span data-stu-id="5ae63-121">Scale in when you no longer need the resources.</span></span>
    
- <span data-ttu-id="5ae63-122">**資料中心承諾較低**使用 Azure 基礎結構服務，而不是在不同的區域中投資至次要資料中心。</span><span class="sxs-lookup"><span data-stu-id="5ae63-122">**Lower datacenter commitment** Use Azure Infrastructure Services instead of investing in a secondary datacenter in a different region.</span></span>
    
<span data-ttu-id="5ae63-123">組織的選項非常不復雜，只是針對具有高恢復性需求的組織開始使用災難修復和高級選項。</span><span class="sxs-lookup"><span data-stu-id="5ae63-123">There are less-complex options for organizations just getting started with disaster recovery and advanced options for organizations with high-resilience requirements.</span></span> <span data-ttu-id="5ae63-124">當環境主控于雲端平臺上時，cold、溫及熱備用環境的定義會有些不同。</span><span class="sxs-lookup"><span data-stu-id="5ae63-124">The definitions for cold, warm, and hot standby environments are a little different when the environment is hosted on a cloud platform.</span></span> <span data-ttu-id="5ae63-125">下表說明這些在 Azure 中建立 SharePoint 復原伺服器陣列的環境。</span><span class="sxs-lookup"><span data-stu-id="5ae63-125">The following table describes these environments for building a SharePoint recovery farm in Azure.</span></span>
  
<span data-ttu-id="5ae63-126">**表：復原環境**</span><span class="sxs-lookup"><span data-stu-id="5ae63-126">**Table: Recovery environments**</span></span>

|<span data-ttu-id="5ae63-127">**復原環境的類型**</span><span class="sxs-lookup"><span data-stu-id="5ae63-127">**Type of recovery environment**</span></span>|<span data-ttu-id="5ae63-128">**描述**</span><span class="sxs-lookup"><span data-stu-id="5ae63-128">**Description**</span></span>|
|:-----|:-----|
|<span data-ttu-id="5ae63-129">熱</span><span class="sxs-lookup"><span data-stu-id="5ae63-129">Hot</span></span>  <br/> |<span data-ttu-id="5ae63-130">在待命中布建、更新及執行完全大小的伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-130">A fully sized farm is provisioned, updated, and running on standby.</span></span>  <br/> |
|<span data-ttu-id="5ae63-131">溫暖</span><span class="sxs-lookup"><span data-stu-id="5ae63-131">Warm</span></span>  <br/> |<span data-ttu-id="5ae63-132">伺服器陣列已建立，且虛擬機器正在執行並更新。</span><span class="sxs-lookup"><span data-stu-id="5ae63-132">The farm is built and virtual machines are running and updated.</span></span>  <br/> <span data-ttu-id="5ae63-133">復原包括附加內容資料庫、布建服務應用程式，以及編目內容。</span><span class="sxs-lookup"><span data-stu-id="5ae63-133">Recovery includes attaching content databases, provisioning service applications, and crawling content.</span></span>  <br/> <span data-ttu-id="5ae63-134">伺服器陣列可以是較小版本的實際執行伺服器陣列，然後擴充以服務于完整的使用者群。</span><span class="sxs-lookup"><span data-stu-id="5ae63-134">The farm can be a smaller version of the production farm and then scaled out to serve the full user base.</span></span>  <br/> |
|<span data-ttu-id="5ae63-135">冷</span><span class="sxs-lookup"><span data-stu-id="5ae63-135">Cold</span></span>  <br/> |<span data-ttu-id="5ae63-136">伺服器陣列已完全建立，但虛擬機器已停止。</span><span class="sxs-lookup"><span data-stu-id="5ae63-136">The farm is fully built, but the virtual machines are stopped.</span></span>  <br/> <span data-ttu-id="5ae63-137">維護環境包括從時間開始虛擬機器、修補、更新及驗證環境。</span><span class="sxs-lookup"><span data-stu-id="5ae63-137">Maintaining the environment includes starting the virtual machines from time to time, patching, updating, and verifying the environment.</span></span>  <br/> <span data-ttu-id="5ae63-138">發生嚴重損壞時，請啟動完整環境。</span><span class="sxs-lookup"><span data-stu-id="5ae63-138">Start the full environment in the event of a disaster.</span></span>  <br/> |
   
<span data-ttu-id="5ae63-139">請務必評估貴組織的復原時間目標（Rto）和復原點目標（Rpo）。</span><span class="sxs-lookup"><span data-stu-id="5ae63-139">It's important to evaluate your organization's Recovery Time Objectives (RTOs) and Recovery Point Objectives (RPOs).</span></span> <span data-ttu-id="5ae63-140">這些需求決定哪個環境為您的組織最適合的投資。</span><span class="sxs-lookup"><span data-stu-id="5ae63-140">These requirements determine which environment is the most appropriate investment for your organization.</span></span>
  
<span data-ttu-id="5ae63-141">本文中的指導方針會說明如何執行預熱的待機環境。</span><span class="sxs-lookup"><span data-stu-id="5ae63-141">The guidance in this article describes how to implement a warm standby environment.</span></span> <span data-ttu-id="5ae63-142">您也可以將它調整為 cold 待命環境，但是您必須遵循其他程式以支援這類環境。</span><span class="sxs-lookup"><span data-stu-id="5ae63-142">You can also adapt it to a cold standby environment, although you need to follow additional procedures to support this kind of environment.</span></span> <span data-ttu-id="5ae63-143">本文不會說明如何執行熱待機環境。</span><span class="sxs-lookup"><span data-stu-id="5ae63-143">This article does not describe how to implement a hot standby environment.</span></span>
  
<span data-ttu-id="5ae63-144">如需有關嚴重損壞修復解決方案的詳細資訊，請參閱[SharePoint 2013 的高可用性和嚴重損壞修復概念](https://go.microsoft.com/fwlink/p/?LinkID=393114)，然後[選擇 SharePoint 2013](https://go.microsoft.com/fwlink/p/?linkid=203228)的嚴重損壞修復策略。</span><span class="sxs-lookup"><span data-stu-id="5ae63-144">For more information about disaster recovery solutions, see [High availability and disaster recovery concepts in SharePoint 2013](https://go.microsoft.com/fwlink/p/?LinkID=393114) and [Choose a disaster recovery strategy for SharePoint 2013](https://go.microsoft.com/fwlink/p/?linkid=203228).</span></span>
  
## <a name="solution-description"></a><span data-ttu-id="5ae63-145">解決方案說明</span><span class="sxs-lookup"><span data-stu-id="5ae63-145">Solution description</span></span>

<span data-ttu-id="5ae63-146">暖色待命災害復原解決方案需要下列環境：</span><span class="sxs-lookup"><span data-stu-id="5ae63-146">The warm standby disaster-recovery solution requires the following environment:</span></span>
  
- <span data-ttu-id="5ae63-147">內部部署 SharePoint 的實際執行伺服器陣列</span><span class="sxs-lookup"><span data-stu-id="5ae63-147">An on-premises SharePoint production farm</span></span>
    
- <span data-ttu-id="5ae63-148">Azure 中的復原 SharePoint 伺服器陣列</span><span class="sxs-lookup"><span data-stu-id="5ae63-148">A recovery SharePoint farm in Azure</span></span>
    
- <span data-ttu-id="5ae63-149">兩個環境間的網站對網站 VPN 連線</span><span class="sxs-lookup"><span data-stu-id="5ae63-149">A site-to-site VPN connection between the two environments</span></span>
    
<span data-ttu-id="5ae63-150">下圖說明這三個元素。</span><span class="sxs-lookup"><span data-stu-id="5ae63-150">The following figure illustrates these three elements.</span></span>
  
<span data-ttu-id="5ae63-151">**圖： Azure 中的暖色待命方案元素**</span><span class="sxs-lookup"><span data-stu-id="5ae63-151">**Figure: Elements of a warm standby solution in Azure**</span></span>

![Azure 中 SharePoint 暖待命解決方案的元素](media/AZarch-AZWarmStndby.png)
  
<span data-ttu-id="5ae63-153">使用分散式檔案系統複寫（DFSR）的 SQL Server 記錄傳送，可將資料庫備份和交易記錄檔複製到 Azure 中的復原伺服器陣列：</span><span class="sxs-lookup"><span data-stu-id="5ae63-153">SQL Server log shipping with Distributed File System Replication (DFSR) is used to copy database backups and transaction logs to the recovery farm in Azure:</span></span> 
  
- <span data-ttu-id="5ae63-154">DFSR 會將記錄從實際執行環境轉移至復原環境。</span><span class="sxs-lookup"><span data-stu-id="5ae63-154">DFSR transfers logs from the production environment to the recovery environment.</span></span> <span data-ttu-id="5ae63-155">在 WAN 案例中，DFSR 比直接將記錄傳送至 Azure 中的次要伺服器更為有效率。</span><span class="sxs-lookup"><span data-stu-id="5ae63-155">In a WAN scenario, DFSR is more efficient than shipping the logs directly to the secondary server in Azure.</span></span>
    
- <span data-ttu-id="5ae63-156">將記錄檔重播至 Azure 的復原環境中的 SQL Server。</span><span class="sxs-lookup"><span data-stu-id="5ae63-156">Logs are replayed to the SQL Server in the recovery environment in Azure.</span></span>
    
- <span data-ttu-id="5ae63-157">除非執行復原練習，否則您不會在復原環境中附加記錄傳送的 SharePoint 內容資料庫。</span><span class="sxs-lookup"><span data-stu-id="5ae63-157">You don't attach log-shipped SharePoint content databases in the recovery environment until a recovery exercise is performed.</span></span>
    
<span data-ttu-id="5ae63-158">若要復原伺服器陣列，請執行下列步驟：</span><span class="sxs-lookup"><span data-stu-id="5ae63-158">Perform the following steps to recover the farm:</span></span>
  
1. <span data-ttu-id="5ae63-159">停止記錄傳送。</span><span class="sxs-lookup"><span data-stu-id="5ae63-159">Stop log shipping.</span></span>
    
2. <span data-ttu-id="5ae63-160">停止接受主要伺服器陣列的流量。</span><span class="sxs-lookup"><span data-stu-id="5ae63-160">Stop accepting traffic to the primary farm.</span></span>
    
3. <span data-ttu-id="5ae63-161">重新顯示最後的交易記錄檔。</span><span class="sxs-lookup"><span data-stu-id="5ae63-161">Replay the final transaction logs.</span></span>
    
4. <span data-ttu-id="5ae63-162">將內容資料庫附加至伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-162">Attach the content databases to the farm.</span></span>
    
5. <span data-ttu-id="5ae63-163">從複製的服務資料庫還原服務應用程式。</span><span class="sxs-lookup"><span data-stu-id="5ae63-163">Restore service applications from the replicated services databases.</span></span>
    
6. <span data-ttu-id="5ae63-164">更新網域名稱系統（DNS）記錄，以指向復原伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-164">Update Domain Name System (DNS) records to point to the recovery farm.</span></span>
    
7. <span data-ttu-id="5ae63-165">開始完整編目。</span><span class="sxs-lookup"><span data-stu-id="5ae63-165">Start a full crawl.</span></span>
    
<span data-ttu-id="5ae63-166">建議您定期預演這些步驟，並加以記錄以協助確保即時修復順利執行。</span><span class="sxs-lookup"><span data-stu-id="5ae63-166">We recommend that you rehearse these steps regularly and document them to help ensure that your live recovery runs smoothly.</span></span> <span data-ttu-id="5ae63-167">附加內容資料庫及還原服務應用程式可能需要一些時間，通常需要一些手動設定。</span><span class="sxs-lookup"><span data-stu-id="5ae63-167">Attaching content databases and restoring service applications can take some time and typically involves some manual configuration.</span></span>
  
<span data-ttu-id="5ae63-168">執行復原後，此解決方案會提供下表所列的專案。</span><span class="sxs-lookup"><span data-stu-id="5ae63-168">After a recovery is performed, this solution provides the items listed in the following table.</span></span>
  
<span data-ttu-id="5ae63-169">**表：解決方案復原目標**</span><span class="sxs-lookup"><span data-stu-id="5ae63-169">**Table: Solution recovery objectives**</span></span>

|<span data-ttu-id="5ae63-170">**項目**</span><span class="sxs-lookup"><span data-stu-id="5ae63-170">**Item**</span></span>|<span data-ttu-id="5ae63-171">**描述**</span><span class="sxs-lookup"><span data-stu-id="5ae63-171">**Description**</span></span>|
|:-----|:-----|
|<span data-ttu-id="5ae63-172">網站和內容</span><span class="sxs-lookup"><span data-stu-id="5ae63-172">Sites and content</span></span>  <br/> |<span data-ttu-id="5ae63-173">網站和內容可在復原環境中使用。</span><span class="sxs-lookup"><span data-stu-id="5ae63-173">Sites and content are available in the recovery environment.</span></span>  <br/> |
|<span data-ttu-id="5ae63-174">新的搜尋實例</span><span class="sxs-lookup"><span data-stu-id="5ae63-174">A new instance of search</span></span>  <br/> |<span data-ttu-id="5ae63-175">在此暖色待命方案中，不會從搜尋資料庫還原搜尋。</span><span class="sxs-lookup"><span data-stu-id="5ae63-175">In this warm standby solution, search is not restored from search databases.</span></span> <span data-ttu-id="5ae63-176">復原伺服器陣列中的搜尋元件與實際執行伺服器陣列盡可能地設定。</span><span class="sxs-lookup"><span data-stu-id="5ae63-176">Search components in the recovery farm are configured as similarly as possible to the production farm.</span></span> <span data-ttu-id="5ae63-177">還原網站和內容之後，就會開始完整編目以重建搜尋索引。</span><span class="sxs-lookup"><span data-stu-id="5ae63-177">After the sites and content are restored, a full crawl is started to rebuild the search index.</span></span> <span data-ttu-id="5ae63-178">您不需要等候編目即可完成，讓網站和內容能夠可用。</span><span class="sxs-lookup"><span data-stu-id="5ae63-178">You do not need to wait for the crawl to complete to make the sites and content available.</span></span>  <br/> |
|<span data-ttu-id="5ae63-179">服務</span><span class="sxs-lookup"><span data-stu-id="5ae63-179">Services</span></span>  <br/> | <span data-ttu-id="5ae63-180">在資料庫中儲存資料的服務會從記錄傳送資料庫還原。</span><span class="sxs-lookup"><span data-stu-id="5ae63-180">Services that store data in databases are restored from the log-shipped databases.</span></span> <span data-ttu-id="5ae63-181">不會將資料儲存在資料庫中的服務只是啟動。</span><span class="sxs-lookup"><span data-stu-id="5ae63-181">Services that do not store data in databases are simply started.</span></span> <br/>  <span data-ttu-id="5ae63-182">並非所有包含資料庫的服務都必須還原。</span><span class="sxs-lookup"><span data-stu-id="5ae63-182">Not all services with databases need to be restored.</span></span> <span data-ttu-id="5ae63-183">下列服務不需要從資料庫還原，而且可以在容錯移轉後直接啟動：</span><span class="sxs-lookup"><span data-stu-id="5ae63-183">The following services do not need to be restored from databases and can simply be started after failover:</span></span> <br/>  <span data-ttu-id="5ae63-184">Usage and Health Data Collection</span><span class="sxs-lookup"><span data-stu-id="5ae63-184">Usage and Health Data Collection</span></span> <br/>  <span data-ttu-id="5ae63-185">狀態服務</span><span class="sxs-lookup"><span data-stu-id="5ae63-185">State service</span></span> <br/>  <span data-ttu-id="5ae63-186">Word automation</span><span class="sxs-lookup"><span data-stu-id="5ae63-186">Word automation</span></span> <br/>  <span data-ttu-id="5ae63-187">任何未使用資料庫的其他服務</span><span class="sxs-lookup"><span data-stu-id="5ae63-187">Any other service that doesn't use a database</span></span> <br/> |
   
<span data-ttu-id="5ae63-188">您可以與 Microsoft 諮詢服務（MCS）或合作夥伴合作，以處理更複雜的復原目標。</span><span class="sxs-lookup"><span data-stu-id="5ae63-188">You can work with Microsoft Consulting Services (MCS) or a partner to address more-complex recovery objectives.</span></span> <span data-ttu-id="5ae63-189">下表摘要說明這些摘要。</span><span class="sxs-lookup"><span data-stu-id="5ae63-189">These are summarized in the following table.</span></span>
  
<span data-ttu-id="5ae63-190">**表：其他可由 MCS 或合作夥伴處理的專案**</span><span class="sxs-lookup"><span data-stu-id="5ae63-190">**Table: Other items that can be addressed by MCS or a partner**</span></span>

|<span data-ttu-id="5ae63-191">**項目**</span><span class="sxs-lookup"><span data-stu-id="5ae63-191">**Item**</span></span>|<span data-ttu-id="5ae63-192">**描述**</span><span class="sxs-lookup"><span data-stu-id="5ae63-192">**Description**</span></span>|
|:-----|:-----|
|<span data-ttu-id="5ae63-193">同步處理自訂伺服器陣列解決方案</span><span class="sxs-lookup"><span data-stu-id="5ae63-193">Synchronizing custom farm solutions</span></span>  <br/> |<span data-ttu-id="5ae63-194">理想狀況下，復原伺服器陣列設定與實際執行伺服器陣列相同。</span><span class="sxs-lookup"><span data-stu-id="5ae63-194">Ideally, the recovery farm configuration is identical to the production farm.</span></span> <span data-ttu-id="5ae63-195">您可以與顧問或合作夥伴合作，評估是否要複製自訂的伺服器陣列解決方案，以及是否已將兩個環境同步處理。</span><span class="sxs-lookup"><span data-stu-id="5ae63-195">You can work with a consultant or partner to evaluate whether custom farm solutions are replicated and whether the process is in place for keeping the two environments synchronized.</span></span>  <br/> |
|<span data-ttu-id="5ae63-196">連接至內部部署的資料來源</span><span class="sxs-lookup"><span data-stu-id="5ae63-196">Connections to data sources on-premises</span></span>  <br/> |<span data-ttu-id="5ae63-197">將連線到後端資料系統（如備份網域控制站（BDC）連線和搜尋內容來源）進行複製時，可能不會有實際的意義。</span><span class="sxs-lookup"><span data-stu-id="5ae63-197">It might not be practical to replicate connections to back-end data systems, such as backup domain controller (BDC) connections and search content sources.</span></span>  <br/> |
|<span data-ttu-id="5ae63-198">搜尋還原案例</span><span class="sxs-lookup"><span data-stu-id="5ae63-198">Search restore scenarios</span></span>  <br/> |<span data-ttu-id="5ae63-199">因為企業搜尋部署一般都是非常獨特且複雜，所以從資料庫還原搜尋需要更多的投資。</span><span class="sxs-lookup"><span data-stu-id="5ae63-199">Because enterprise search deployments tend to be fairly unique and complex, restoring search from databases requires a greater investment.</span></span> <span data-ttu-id="5ae63-200">您可以與顧問或合作夥伴合作，識別及執行您的組織可能需要的搜尋還原案例。</span><span class="sxs-lookup"><span data-stu-id="5ae63-200">You can work with a consultant or partner to identify and implement search restore scenarios that your organization might require.</span></span>  <br/> |
   
<span data-ttu-id="5ae63-201">本文所提供的指導方針假設已經設計及部署了內部部署伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-201">The guidance provided in this article assumes that the on-premises farm is already designed and deployed.</span></span>
  
## <a name="detailed-architecture"></a><span data-ttu-id="5ae63-202">詳細架構</span><span class="sxs-lookup"><span data-stu-id="5ae63-202">Detailed architecture</span></span>

<span data-ttu-id="5ae63-203">理想狀況下，Azure 中的復原伺服器陣列設定與實際部署的實際執行伺服器陣列相同，包括下列各項：</span><span class="sxs-lookup"><span data-stu-id="5ae63-203">Ideally, the recovery farm configuration in Azure is identical to the production farm on-premises, including the following:</span></span>
  
- <span data-ttu-id="5ae63-204">伺服器角色的相同標記法</span><span class="sxs-lookup"><span data-stu-id="5ae63-204">The same representation of server roles</span></span>
    
- <span data-ttu-id="5ae63-205">自訂的相同設定</span><span class="sxs-lookup"><span data-stu-id="5ae63-205">The same configuration of customizations</span></span>
    
- <span data-ttu-id="5ae63-206">相同的搜尋元件設定</span><span class="sxs-lookup"><span data-stu-id="5ae63-206">The same configuration of search components</span></span>
    
<span data-ttu-id="5ae63-207">Azure 中的環境可以是較小版本的實際執行伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-207">The environment in Azure can be a smaller version of the production farm.</span></span> <span data-ttu-id="5ae63-208">如果您打算在容錯移轉後擴充復原伺服器陣列，則必須最初代表每一種類型的伺服器角色。</span><span class="sxs-lookup"><span data-stu-id="5ae63-208">If you plan to scale out the recovery farm after failover, it's important that each type of server role be initially represented.</span></span>
  
<span data-ttu-id="5ae63-209">在容錯移轉環境中進行複寫時，有些設定可能不實用。</span><span class="sxs-lookup"><span data-stu-id="5ae63-209">Some configurations might not be practical to replicate in the failover environment.</span></span> <span data-ttu-id="5ae63-210">請務必測試容錯移轉程式和環境，以協助確保容錯移轉伺服器陣列提供預期的服務等級。</span><span class="sxs-lookup"><span data-stu-id="5ae63-210">Be sure to test the failover procedures and environment to help ensure that the failover farm provides the expected service level.</span></span>
  
<span data-ttu-id="5ae63-211">此方案不規定 SharePoint 伺服器陣列的特定拓撲。</span><span class="sxs-lookup"><span data-stu-id="5ae63-211">This solution doesn't prescribe a specific topology for a SharePoint farm.</span></span> <span data-ttu-id="5ae63-212">此解決方案的重點是使用 Azure 進行容錯移轉伺服器陣列，並在兩個環境間執行記錄傳送和 DFSR。</span><span class="sxs-lookup"><span data-stu-id="5ae63-212">The focus of this solution is to use Azure for the failover farm and to implement log shipping and DFSR between the two environments.</span></span>
  
### <a name="warm-standby-environments"></a><span data-ttu-id="5ae63-213">暖色待命環境</span><span class="sxs-lookup"><span data-stu-id="5ae63-213">Warm standby environments</span></span>

<span data-ttu-id="5ae63-214">在暖待命環境中，Azure 環境中的所有虛擬機器都在執行中。</span><span class="sxs-lookup"><span data-stu-id="5ae63-214">In a warm standby environment, all virtual machines in the Azure environment are running.</span></span> <span data-ttu-id="5ae63-215">環境已準備好進行容錯移轉練習或事件。</span><span class="sxs-lookup"><span data-stu-id="5ae63-215">The environment is ready for a failover exercise or event.</span></span>
  
<span data-ttu-id="5ae63-216">下圖說明從內部部署 SharePoint 伺服器陣列到設定為暖色待命環境之 Azure 架構 SharePoint 伺服器陣列的嚴重損壞修復解決方案。</span><span class="sxs-lookup"><span data-stu-id="5ae63-216">The following figure illustrates a disaster recovery solution from an on-premises SharePoint farm to an Azure-based SharePoint farm that is configured as a warm standby environment.</span></span>
  
<span data-ttu-id="5ae63-217">**圖：實際執行伺服器陣列和暖待命復原伺服器陣列的拓撲和重要專案**</span><span class="sxs-lookup"><span data-stu-id="5ae63-217">**Figure: Topology and key elements of a production farm and a warm standby recovery farm**</span></span>

![SharePoint 伺服器陣列和暖待命復原伺服器陣列的拓撲](media/AZarch-AZWarmStndby.png)
  
<span data-ttu-id="5ae63-219">在此圖表中：</span><span class="sxs-lookup"><span data-stu-id="5ae63-219">In this diagram:</span></span>
  
- <span data-ttu-id="5ae63-220">並排說明兩個環境：內部部署 SharePoint 伺服器陣列和 Azure 中的暖色待命伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-220">Two environments are illustrated side by side: the on-premises SharePoint farm and the warm standby farm in Azure.</span></span>
    
- <span data-ttu-id="5ae63-221">每個環境都包括檔案共用。</span><span class="sxs-lookup"><span data-stu-id="5ae63-221">Each environment includes a file share.</span></span>
    
- <span data-ttu-id="5ae63-222">每個伺服器陣列包含四個層。</span><span class="sxs-lookup"><span data-stu-id="5ae63-222">Each farm includes four tiers.</span></span> <span data-ttu-id="5ae63-223">為了實現高可用性，每一層都包含兩個伺服器或虛擬機器，其設定與特定角色相同，例如前端服務、分散式快取、後端服務和資料庫。</span><span class="sxs-lookup"><span data-stu-id="5ae63-223">To achieve high availability, each tier includes two servers or virtual machines that are configured identically for a specific role, such as front-end services, distributed cache, back-end services, and databases.</span></span> <span data-ttu-id="5ae63-224">請不要在此圖例中撥打特定的元件。</span><span class="sxs-lookup"><span data-stu-id="5ae63-224">It isn't important in this illustration to call out specific components.</span></span> <span data-ttu-id="5ae63-225">兩個伺服器陣列的設定都相同。</span><span class="sxs-lookup"><span data-stu-id="5ae63-225">The two farms are configured identically.</span></span>
    
- <span data-ttu-id="5ae63-226">第四層是資料庫層。</span><span class="sxs-lookup"><span data-stu-id="5ae63-226">The fourth tier is the database tier.</span></span> <span data-ttu-id="5ae63-227">記錄傳送可用於將記錄從內部部署環境中的輔助資料庫伺服器複製到相同環境中的檔案共用。</span><span class="sxs-lookup"><span data-stu-id="5ae63-227">Log shipping is used to copy logs from the secondary database server in the on-premises environment to the file share in the same environment.</span></span>
    
- <span data-ttu-id="5ae63-228">DFSR 會將檔案從內部部署環境中的檔案共用複製至 Azure 環境中的檔案共用。</span><span class="sxs-lookup"><span data-stu-id="5ae63-228">DFSR copies files from the file share in the on-premises environment to the file share in the Azure environment.</span></span>
    
- <span data-ttu-id="5ae63-229">記錄傳送會將記錄從 Azure 環境中的檔案共用重新執行至復原環境的 SQL Server AlwaysOn 可用性群組中的主要複本。</span><span class="sxs-lookup"><span data-stu-id="5ae63-229">Log shipping replays the logs from the file share in the Azure environment to the primary replica in the SQL Server AlwaysOn availability group in the recovery environment.</span></span>
    
### <a name="cold-standby-environments"></a><span data-ttu-id="5ae63-230">Cold 待命環境</span><span class="sxs-lookup"><span data-stu-id="5ae63-230">Cold standby environments</span></span>

<span data-ttu-id="5ae63-231">在冷待命環境中，大部分的 SharePoint 伺服器陣列虛擬機器都可以關閉。</span><span class="sxs-lookup"><span data-stu-id="5ae63-231">In a cold standby environment, most of the SharePoint farm virtual machines can be shut down.</span></span> <span data-ttu-id="5ae63-232">（我們建議您偶爾開始虛擬機器，例如每兩周或每月一次，讓每個虛擬機器都可以與網域同步。）Azure 復原環境中的下列虛擬機器必須保持執行，以協助確保記錄傳送和 DFSR 連續運作：</span><span class="sxs-lookup"><span data-stu-id="5ae63-232">(We recommend occasionally starting the virtual machines, such as every two weeks or once a month, so that each virtual machine can sync with the domain.) The following virtual machines in the Azure recovery environment must remain running to help ensure continuous operations of log shipping and DFSR:</span></span>
  
- <span data-ttu-id="5ae63-233">檔案共用</span><span class="sxs-lookup"><span data-stu-id="5ae63-233">The file share</span></span>
    
- <span data-ttu-id="5ae63-234">主資料庫伺服器</span><span class="sxs-lookup"><span data-stu-id="5ae63-234">The primary database server</span></span>
    
- <span data-ttu-id="5ae63-235">至少一部執行 Windows Server Active Directory 網域服務和 DNS 的虛擬機器</span><span class="sxs-lookup"><span data-stu-id="5ae63-235">At least one virtual machine running Windows Server Active Directory Domain Services and DNS</span></span>
    
<span data-ttu-id="5ae63-236">下圖顯示執行檔案共用虛擬機器及主要 SharePoint 資料庫虛擬機器的 Azure 容錯移轉環境。</span><span class="sxs-lookup"><span data-stu-id="5ae63-236">The following figure shows an Azure failover environment in which the file share virtual machine and the primary SharePoint database virtual machine are running.</span></span> <span data-ttu-id="5ae63-237">所有其他的 SharePoint 虛擬機器都已停止。</span><span class="sxs-lookup"><span data-stu-id="5ae63-237">All other SharePoint virtual machines are stopped.</span></span> <span data-ttu-id="5ae63-238">不會顯示執行 Windows Server Active Directory 和 DNS 的虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="5ae63-238">The virtual machine that is running Windows Server Active Directory and DNS is not shown.</span></span>
  
<span data-ttu-id="5ae63-239">**圖：具有執行虛擬機器的 Cold 待命復原伺服器陣列**</span><span class="sxs-lookup"><span data-stu-id="5ae63-239">**Figure: Cold standby recovery farm with running virtual machines**</span></span>

![Azure 中 SharePoint 冷待命解決方案的元素](media/AZarch-AZColdStndby.png)
  
<span data-ttu-id="5ae63-241">容錯移轉至冷待命環境之後，所有虛擬機器都會啟動，而且必須設定實現資料庫伺服器高可用性的方法，例如 SQL Server AlwaysOn 可用性群組。</span><span class="sxs-lookup"><span data-stu-id="5ae63-241">After failover to a cold standby environment, all virtual machines are started, and the method to achieve high availability of the database servers must be configured, such as SQL Server AlwaysOn availability groups.</span></span>
  
<span data-ttu-id="5ae63-242">如果已執行多個儲存群組（資料庫分散在多個 SQL Server 高可用性集內），則每個儲存群組的主資料庫必須執行，以接受與其儲存群組相關聯的記錄。</span><span class="sxs-lookup"><span data-stu-id="5ae63-242">If multiple storage groups are implemented (databases are spread across more than one SQL Server high availability set), the primary database for each storage group must be running to accept the logs associated with its storage group.</span></span>
  
### <a name="skills-and-experience"></a><span data-ttu-id="5ae63-243">技能和經驗</span><span class="sxs-lookup"><span data-stu-id="5ae63-243">Skills and experience</span></span>

<span data-ttu-id="5ae63-244">在此嚴重損壞修復解決方案中使用多項技術。</span><span class="sxs-lookup"><span data-stu-id="5ae63-244">Multiple technologies are used in this disaster recovery solution.</span></span> <span data-ttu-id="5ae63-245">為了協助確保這些技術如預期的方式互動，必須正確安裝和設定內部部署和 Azure 環境中的每個元件。</span><span class="sxs-lookup"><span data-stu-id="5ae63-245">To help ensure that these technologies interact as expected, each component in the on-premises and Azure environment must be installed and configured correctly.</span></span> <span data-ttu-id="5ae63-246">建議設定此解決方案的人員或小組具備下列文章中所述技術，具有和實際執行技能的強有力的工作知識。</span><span class="sxs-lookup"><span data-stu-id="5ae63-246">We recommend that the person or team who sets up this solution have a strong working knowledge of and hands-on skills with the technologies described in the following articles:</span></span>
  
- [<span data-ttu-id="5ae63-247">分散式檔案系統（DFS）複寫服務</span><span class="sxs-lookup"><span data-stu-id="5ae63-247">Distributed File System (DFS) Replication Services</span></span>](https://go.microsoft.com/fwlink/p/?LinkId=392698)
    
- [<span data-ttu-id="5ae63-248">使用 SQL Server 的 Windows Server 容錯移轉叢集（WSFC）</span><span class="sxs-lookup"><span data-stu-id="5ae63-248">Windows Server Failover Clustering (WSFC) with SQL Server</span></span>](https://go.microsoft.com/fwlink/p/?LinkId=392701)
    
- [<span data-ttu-id="5ae63-249">AlwaysOn 可用性群組 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="5ae63-249">AlwaysOn Availability Groups (SQL Server)</span></span>](https://go.microsoft.com/fwlink/p/?LinkId=392725)
    
- [<span data-ttu-id="5ae63-250">備份及還原 SQL Server 資料庫</span><span class="sxs-lookup"><span data-stu-id="5ae63-250">Back Up and Restore of SQL Server Databases</span></span>](https://go.microsoft.com/fwlink/p/?LinkId=392728)
    
- [<span data-ttu-id="5ae63-251">SharePoint Server 2013 安裝和伺服器陣列部署</span><span class="sxs-lookup"><span data-stu-id="5ae63-251">SharePoint Server 2013 installation and farm deployment</span></span>](https://go.microsoft.com/fwlink/p/?LinkId=393119)
    
- [<span data-ttu-id="5ae63-252">Microsoft Azure</span><span class="sxs-lookup"><span data-stu-id="5ae63-252">Microsoft Azure</span></span>](https://go.microsoft.com/fwlink/p/?LinkId=392729)
    
<span data-ttu-id="5ae63-253">最後，我們建議您可以用來自動化與這些技術相關之工作的腳本技能。</span><span class="sxs-lookup"><span data-stu-id="5ae63-253">Finally, we recommend scripting skills that you can use to automate tasks associated with these technologies.</span></span> <span data-ttu-id="5ae63-254">您可以使用可用的使用者介面，以完成此方案中所述的所有工作。</span><span class="sxs-lookup"><span data-stu-id="5ae63-254">It's possible to use the available user interfaces to complete all the tasks described in this solution.</span></span> <span data-ttu-id="5ae63-255">不過，手動方法可能非常耗時且容易出錯，並提供不一致的結果。</span><span class="sxs-lookup"><span data-stu-id="5ae63-255">However, a manual approach can be time consuming and error prone and delivers inconsistent results.</span></span>
  
<span data-ttu-id="5ae63-256">除了 Windows PowerShell 之外，還有 SQL Server、SharePoint Server 和 Azure 的 Windows PowerShell 文件庫。</span><span class="sxs-lookup"><span data-stu-id="5ae63-256">In addition to Windows PowerShell, there are also Windows PowerShell libraries for SQL Server, SharePoint Server, and Azure.</span></span> <span data-ttu-id="5ae63-257">別忘了 T-SQL，也有助於縮短設定及維護災難復原環境的時間。</span><span class="sxs-lookup"><span data-stu-id="5ae63-257">Don't forget T-SQL, which can also help reduce the time to configure and maintain your disaster-recovery environment.</span></span>
  
## <a name="disaster-recovery-roadmap"></a><span data-ttu-id="5ae63-258">嚴重損壞修復藍圖</span><span class="sxs-lookup"><span data-stu-id="5ae63-258">Disaster recovery roadmap</span></span>

![SharePoint 嚴重損壞修復藍圖的視覺表示法。](media/Azure-DRroadmap.png)
  
<span data-ttu-id="5ae63-260">此藍圖假設您已在生產環境中部署 SharePoint Server 2013 伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-260">This roadmap assumes that you already have a SharePoint Server 2013 farm deployed in production.</span></span>
  
<span data-ttu-id="5ae63-261">**表：嚴重損壞修復的藍圖**</span><span class="sxs-lookup"><span data-stu-id="5ae63-261">**Table: Roadmap for disaster recovery**</span></span>

|<span data-ttu-id="5ae63-262">**階段**</span><span class="sxs-lookup"><span data-stu-id="5ae63-262">**Phase**</span></span>|<span data-ttu-id="5ae63-263">**描述**</span><span class="sxs-lookup"><span data-stu-id="5ae63-263">**Description**</span></span>|
|:-----|:-----|
|<span data-ttu-id="5ae63-264">階段1</span><span class="sxs-lookup"><span data-stu-id="5ae63-264">Phase 1</span></span>  <br/> |<span data-ttu-id="5ae63-265">設計嚴重損壞修復環境。</span><span class="sxs-lookup"><span data-stu-id="5ae63-265">Design the disaster recovery environment.</span></span>  <br/> |
|<span data-ttu-id="5ae63-266">階段2</span><span class="sxs-lookup"><span data-stu-id="5ae63-266">Phase 2</span></span>  <br/> |<span data-ttu-id="5ae63-267">建立 Azure 虛擬網路和 VPN 連線。</span><span class="sxs-lookup"><span data-stu-id="5ae63-267">Create the Azure virtual network and VPN connection.</span></span>  <br/> |
|<span data-ttu-id="5ae63-268">階段3</span><span class="sxs-lookup"><span data-stu-id="5ae63-268">Phase 3</span></span>  <br/> |<span data-ttu-id="5ae63-269">將 Windows Active Directory 和功能變數名稱服務部署到 Azure 虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="5ae63-269">Deploy Windows Active Directory and Domain Name Services to the Azure virtual network.</span></span>  <br/> |
|<span data-ttu-id="5ae63-270">階段4</span><span class="sxs-lookup"><span data-stu-id="5ae63-270">Phase 4</span></span>  <br/> |<span data-ttu-id="5ae63-271">在 Azure 中部署 SharePoint 復原伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-271">Deploy the SharePoint recovery farm in Azure.</span></span>  <br/> |
|<span data-ttu-id="5ae63-272">階段5</span><span class="sxs-lookup"><span data-stu-id="5ae63-272">Phase 5</span></span>  <br/> |<span data-ttu-id="5ae63-273">在伺服器陣列之間設定 DFSR。</span><span class="sxs-lookup"><span data-stu-id="5ae63-273">Set up DFSR between the farms.</span></span>  <br/> |
|<span data-ttu-id="5ae63-274">階段6</span><span class="sxs-lookup"><span data-stu-id="5ae63-274">Phase 6</span></span>  <br/> |<span data-ttu-id="5ae63-275">設定恢復伺服器陣列的記錄傳送。</span><span class="sxs-lookup"><span data-stu-id="5ae63-275">Set up log shipping to the recovery farm.</span></span>  <br/> |
|<span data-ttu-id="5ae63-276">階段7</span><span class="sxs-lookup"><span data-stu-id="5ae63-276">Phase 7</span></span>  <br/> | <span data-ttu-id="5ae63-277">驗證容錯移轉和復原解決方案。</span><span class="sxs-lookup"><span data-stu-id="5ae63-277">Validate failover and recovery solutions.</span></span> <span data-ttu-id="5ae63-278">這包括下列程式及技術：</span><span class="sxs-lookup"><span data-stu-id="5ae63-278">This includes the following procedures and technologies:</span></span> <br/>  <span data-ttu-id="5ae63-279">停止記錄傳送。</span><span class="sxs-lookup"><span data-stu-id="5ae63-279">Stop log shipping.</span></span> <br/>  <span data-ttu-id="5ae63-280">還原備份。</span><span class="sxs-lookup"><span data-stu-id="5ae63-280">Restore the backups.</span></span> <br/>  <span data-ttu-id="5ae63-281">編目內容。</span><span class="sxs-lookup"><span data-stu-id="5ae63-281">Crawl content.</span></span> <br/>  <span data-ttu-id="5ae63-282">復原服務。</span><span class="sxs-lookup"><span data-stu-id="5ae63-282">Recover services.</span></span> <br/>  <span data-ttu-id="5ae63-283">管理 DNS 記錄。</span><span class="sxs-lookup"><span data-stu-id="5ae63-283">Manage DNS records.</span></span> <br/> |
   
## <a name="phase-1-design-the-disaster-recovery-environment"></a><span data-ttu-id="5ae63-284">階段1：設計嚴重損壞修復環境</span><span class="sxs-lookup"><span data-stu-id="5ae63-284">Phase 1: Design the disaster recovery environment</span></span>

<span data-ttu-id="5ae63-285">使用[Microsoft Azure 架構](microsoft-azure-architectures-for-sharepoint-2013.md)中的指南 SharePoint 2013 來設計災害復原環境，包括 SharePoint 復原伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-285">Use the guidance in [Microsoft Azure Architectures for SharePoint 2013](microsoft-azure-architectures-for-sharepoint-2013.md) to design the disaster-recovery environment, including the SharePoint recovery farm.</span></span> <span data-ttu-id="5ae63-286">您可以使用 Azure Visio 檔案[中 SharePoint](https://go.microsoft.com/fwlink/p/?LinkId=392554)嚴重損壞復原解決方案中的圖形，以啟動設計程式。</span><span class="sxs-lookup"><span data-stu-id="5ae63-286">You can use the graphics in the [SharePoint Disaster Recovery Solution in Azure](https://go.microsoft.com/fwlink/p/?LinkId=392554) Visio file to start the design process.</span></span> <span data-ttu-id="5ae63-287">建議您先設計整個環境，然後再開始執行 Azure 環境中的任何工作。</span><span class="sxs-lookup"><span data-stu-id="5ae63-287">We recommend that you design the entire environment before beginning any work in the Azure environment.</span></span>
  
<span data-ttu-id="5ae63-288">除了用於設計虛擬網路、VPN 連線、Active Directory 及 SharePoint 伺服器陣列的[Microsoft Azure 2013 SharePoint 架構](microsoft-azure-architectures-for-sharepoint-2013.md)中所提供的指引，請務必將檔案共用角色新增至 Azure 環境。</span><span class="sxs-lookup"><span data-stu-id="5ae63-288">In addition to the guidance provided in [Microsoft Azure Architectures for SharePoint 2013](microsoft-azure-architectures-for-sharepoint-2013.md) for designing the virtual network, VPN connection, Active Directory, and SharePoint farm, be sure to add a file share role to the Azure environment.</span></span>
  
<span data-ttu-id="5ae63-289">若要在嚴重損壞修復解決方案中支援記錄傳送，則會將檔案共用虛擬機器新增至資料庫角色所在的子網。</span><span class="sxs-lookup"><span data-stu-id="5ae63-289">To support log shipping in a disaster-recovery solution, a file share virtual machine is added to the subnet where the database roles reside.</span></span> <span data-ttu-id="5ae63-290">檔案共用也充當 SQL Server AlwaysOn 可用性群組的第三個節點的節點。</span><span class="sxs-lookup"><span data-stu-id="5ae63-290">The file share also serves as the third node of a Node Majority for the SQL Server AlwaysOn availability group.</span></span> <span data-ttu-id="5ae63-291">在使用 SQL Server AlwaysOn 可用性群組的標準 SharePoint 伺服器陣列中，這是建議的設定。</span><span class="sxs-lookup"><span data-stu-id="5ae63-291">This is the recommended configuration for a standard SharePoint farm that uses SQL Server AlwaysOn availability groups.</span></span> 
  
> [!NOTE]
> <span data-ttu-id="5ae63-292">務必要檢查資料庫的必要條件，以加入 SQL Server AlwaysOn 可用性群組。</span><span class="sxs-lookup"><span data-stu-id="5ae63-292">It is important to review the prerequisites for a database to participate in a SQL Server AlwaysOn availability group.</span></span> <span data-ttu-id="5ae63-293">如需詳細資訊，請參閱[AlwaysOn 可用性群組的必要條件、限制和建議](https://go.microsoft.com/fwlink/p/?LinkId=510870)。</span><span class="sxs-lookup"><span data-stu-id="5ae63-293">For more information, see [Prerequisites, Restrictions, and Recommendations for AlwaysOn Availability Groups](https://go.microsoft.com/fwlink/p/?LinkId=510870).</span></span> 
  
<span data-ttu-id="5ae63-294">**圖：用於嚴重損壞修復解決方案的檔案伺服器位置**</span><span class="sxs-lookup"><span data-stu-id="5ae63-294">**Figure: Placement of a file server used for a disaster recovery solution**</span></span>

![顯示新增至含有 SharePoint 資料庫伺服器角色之相同雲端服務的檔案共用 VM。](media/AZenv-FSforDFSRandWSFC.png)
  
<span data-ttu-id="5ae63-296">在此圖中，檔案共用虛擬機器會新增至包含資料庫伺服器角色之 Azure 中的相同子網。</span><span class="sxs-lookup"><span data-stu-id="5ae63-296">In this diagram, a file share virtual machine is added to the same subnet in Azure that contains the database server roles.</span></span> <span data-ttu-id="5ae63-297">請勿將檔案共用虛擬機器新增至具有其他伺服器角色的可用性設定，例如 SQL Server 角色。</span><span class="sxs-lookup"><span data-stu-id="5ae63-297">Do not add the file share virtual machine to an availability set with other server roles, such as the SQL Server roles.</span></span>
  
<span data-ttu-id="5ae63-298">如果您擔心記錄的高可用性，請考慮使用[SQL Server 備份和使用 Azure Blob 儲存服務進行還原](https://go.microsoft.com/fwlink/p/?LinkId=393113)，以採取不同的方式。</span><span class="sxs-lookup"><span data-stu-id="5ae63-298">If you are concerned about the high availability of the logs, consider taking a different approach by using [SQL Server backup and restore with Azure Blob Storage Service](https://go.microsoft.com/fwlink/p/?LinkId=393113).</span></span> <span data-ttu-id="5ae63-299">這是 Azure 中的新功能，可直接將記錄儲存至 blob 儲存 URL。</span><span class="sxs-lookup"><span data-stu-id="5ae63-299">This is a new feature in Azure that saves logs directly to a blob storage URL.</span></span> <span data-ttu-id="5ae63-300">此方案不包含使用此功能的指導方針。</span><span class="sxs-lookup"><span data-stu-id="5ae63-300">This solution does not include guidance about using this feature.</span></span>
  
<span data-ttu-id="5ae63-301">當您設計復原伺服器陣列時，請記住成功的嚴重損壞修復環境會正確反映您要復原的實際執行伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-301">When you design the recovery farm, keep in mind that a successful disaster recovery environment accurately reflects the production farm that you want to recover.</span></span> <span data-ttu-id="5ae63-302">復原伺服器陣列的大小並不是復原伺服器陣列設計、部署及測試中最重要的一點。</span><span class="sxs-lookup"><span data-stu-id="5ae63-302">The size of the recovery farm is not the most important thing in the recovery farm's design, deployment, and testing.</span></span> <span data-ttu-id="5ae63-303">伺服器陣列規模會根據業務需求，依組織而異。</span><span class="sxs-lookup"><span data-stu-id="5ae63-303">Farm scale varies from organization to organization based on business requirements.</span></span> <span data-ttu-id="5ae63-304">您可以使用縮小的伺服器陣列進行短暫的中斷，或直到效能與容量需求需要您縮放伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-304">It might be possible to use a scaled-down farm for a short outage or until performance and capacity demands require you to scale the farm.</span></span>
  
<span data-ttu-id="5ae63-305">將復原伺服器陣列盡可能與實際執行伺服器陣列進行相同的設定，使其符合您的服務等級協定（SLA）需求，並提供您支援您的企業所需的功能。</span><span class="sxs-lookup"><span data-stu-id="5ae63-305">Configure the recovery farm as identically as possible to the production farm so that it meets your service level agreement (SLA) requirements and provides the functionality that you need to support your business.</span></span> <span data-ttu-id="5ae63-306">當您設計嚴重損壞復原環境時，也請查看您實際執行環境的變更管理程式。</span><span class="sxs-lookup"><span data-stu-id="5ae63-306">When you design the disaster recovery environment, also look at your change management process for your production environment.</span></span> <span data-ttu-id="5ae63-307">建議您以與實際執行環境相同的間隔更新復原環境，將變更管理程式擴充至復原環境。</span><span class="sxs-lookup"><span data-stu-id="5ae63-307">We recommend that you extend the change management process to the recovery environment by updating the recovery environment at the same interval as the production environment.</span></span> <span data-ttu-id="5ae63-308">在變更管理程式中，我們建議您維護伺服器陣列設定、應用程式和使用者的詳細清查。</span><span class="sxs-lookup"><span data-stu-id="5ae63-308">As part of the change management process, we recommend maintaining a detailed inventory of your farm configuration, applications, and users.</span></span> 
  
## <a name="phase-2-create-the-azure-virtual-network-and-vpn-connection"></a><span data-ttu-id="5ae63-309">階段2：建立 Azure 虛擬網路和 VPN 連線</span><span class="sxs-lookup"><span data-stu-id="5ae63-309">Phase 2: Create the Azure virtual network and VPN connection</span></span>

<span data-ttu-id="5ae63-310">[Connect 內部部署網路與 Microsoft Azure 虛擬網路](connect-an-on-premises-network-to-a-microsoft-azure-virtual-network.md)顯示如何在 Azure 中規劃及部署虛擬網路，以及如何建立 VPN 連線。</span><span class="sxs-lookup"><span data-stu-id="5ae63-310">[Connect an on-premises network to a Microsoft Azure virtual network](connect-an-on-premises-network-to-a-microsoft-azure-virtual-network.md) shows you how to plan and deploy the virtual network in Azure and how to create the VPN connection.</span></span> <span data-ttu-id="5ae63-311">遵循主題中的指導方針完成下列程式：</span><span class="sxs-lookup"><span data-stu-id="5ae63-311">Follow the guidance in the topic to complete the following procedures:</span></span>
  
- <span data-ttu-id="5ae63-312">規劃虛擬網路的私人 IP 位址空間。</span><span class="sxs-lookup"><span data-stu-id="5ae63-312">Plan the private IP address space of the Virtual Network.</span></span>
    
- <span data-ttu-id="5ae63-313">規劃虛擬網路的路由基礎結構變更。</span><span class="sxs-lookup"><span data-stu-id="5ae63-313">Plan the routing infrastructure changes for the Virtual Network.</span></span>
    
- <span data-ttu-id="5ae63-314">規劃進出內部部署 VPN 裝置之流量的防火牆規則。</span><span class="sxs-lookup"><span data-stu-id="5ae63-314">Plan firewall rules for traffic to and from the on-premises VPN device.</span></span>
    
- <span data-ttu-id="5ae63-315">在 Azure 中建立跨單位虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="5ae63-315">Create the cross-premises virtual network in Azure.</span></span>
    
- <span data-ttu-id="5ae63-316">設定您的內部部署網路和虛擬網路之間的路由。</span><span class="sxs-lookup"><span data-stu-id="5ae63-316">Configure routing between your on-premises network and the Virtual Network.</span></span>
    
## <a name="phase-3-deploy-active-directory-and-domain-name-services-to-the-azure-virtual-network"></a><span data-ttu-id="5ae63-317">階段3：將 Active Directory 和功能變數名稱服務部署到 Azure 虛擬網路</span><span class="sxs-lookup"><span data-stu-id="5ae63-317">Phase 3: Deploy Active Directory and Domain Name Services to the Azure virtual network</span></span>

<span data-ttu-id="5ae63-318">這個階段包括將 Windows Server Active Directory 和 DNS 部署至混合案例中的虛擬網路，如[Microsoft Azure 架構中的 SharePoint 2013](microsoft-azure-architectures-for-sharepoint-2013.md)所述，如下圖所示。</span><span class="sxs-lookup"><span data-stu-id="5ae63-318">This phase includes deploying both Windows Server Active Directory and DNS to the Virtual Network in a hybrid scenario as described in [Microsoft Azure Architectures for SharePoint 2013](microsoft-azure-architectures-for-sharepoint-2013.md) and as illustrated in the following figure.</span></span>
  
<span data-ttu-id="5ae63-319">**圖：混合式 Active Directory 網域設定**</span><span class="sxs-lookup"><span data-stu-id="5ae63-319">**Figure: Hybrid Active Directory domain configuration**</span></span>

![兩部部署至 Azure 虛擬網路的虛擬機器，以及 SharePoint 的伺服器陣列子網為複本網域控制站和 DNS 伺服器](media/AZarch-HyADdomainConfig.png)
  
<span data-ttu-id="5ae63-321">在圖例中，兩部虛擬機器會部署至相同的子網。</span><span class="sxs-lookup"><span data-stu-id="5ae63-321">In the illustration, two virtual machines are deployed to the same subnet.</span></span> <span data-ttu-id="5ae63-322">這些虛擬機器分別主控兩個角色： Active Directory 和 DNS。</span><span class="sxs-lookup"><span data-stu-id="5ae63-322">These virtual machines are each hosting two roles: Active Directory and DNS.</span></span>
  
<span data-ttu-id="5ae63-323">在 Azure 中部署 Active Directory 之前，請閱讀[在 Azure 虛擬機器上部署 Windows Server Active Directory 的指導方針](https://go.microsoft.com/fwlink/p/?linkid=392681)。</span><span class="sxs-lookup"><span data-stu-id="5ae63-323">Before deploying Active Directory in Azure, read [Guidelines for Deploying Windows Server Active Directory on Azure Virtual Machines](https://go.microsoft.com/fwlink/p/?linkid=392681).</span></span> <span data-ttu-id="5ae63-324">這些指導方針可協助您判斷方案是否需要不同的架構或不同的設定設定。</span><span class="sxs-lookup"><span data-stu-id="5ae63-324">These guidelines help you determine whether you need a different architecture or different configuration settings for your solution.</span></span>
  
<span data-ttu-id="5ae63-325">如需在 Azure 中設定網域控制站的詳細指導，請參閱[在 Azure 虛擬網路中安裝複本 Active Directory 網域控制站](https://go.microsoft.com/fwlink/p/?LinkId=392687)。</span><span class="sxs-lookup"><span data-stu-id="5ae63-325">For detailed guidance on setting up a domain controller in Azure, see [Install a Replica Active Directory Domain Controller in Azure Virtual Networks](https://go.microsoft.com/fwlink/p/?LinkId=392687).</span></span>
  
<span data-ttu-id="5ae63-326">在此階段之前，您未將虛擬機器部署到虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="5ae63-326">Before this phase, you didn't deploy virtual machines to the Virtual Network.</span></span> <span data-ttu-id="5ae63-327">主控 Active Directory 和 DNS 的虛擬機器可能不是解決方案所需的最大虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="5ae63-327">The virtual machines for hosting Active Directory and DNS are likely not the largest virtual machines you need for the solution.</span></span> <span data-ttu-id="5ae63-328">在您部署這些虛擬機器之前，請先建立您計畫用於虛擬網路的最大虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="5ae63-328">Before you deploy these virtual machines, first create the largest virtual machine that you plan to use in your Virtual Network.</span></span> <span data-ttu-id="5ae63-329">這可協助確保您的解決方案集中于 Azure 中的標記，以允許您需要的最大大小。</span><span class="sxs-lookup"><span data-stu-id="5ae63-329">This helps ensure that your solution lands on a tag in Azure that allows the largest size you need.</span></span> <span data-ttu-id="5ae63-330">此時您不需要設定此虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="5ae63-330">You do not need to configure this virtual machine at this time.</span></span> <span data-ttu-id="5ae63-331">只需建立它，並將它放在一邊。</span><span class="sxs-lookup"><span data-stu-id="5ae63-331">Simply create it, and set it aside.</span></span> <span data-ttu-id="5ae63-332">如果您不這麼做，當您嘗試建立較大的虛擬機器時，可能會發生限制，這是撰寫本文時的問題。</span><span class="sxs-lookup"><span data-stu-id="5ae63-332">If you do not do this, you might run into a limitation when you try to create larger virtual machines later, which was an issue at the time this article was written.</span></span> 
  
## <a name="phase-4-deploy-the-sharepoint-recovery-farm-in-azure"></a><span data-ttu-id="5ae63-333">階段4：在 Azure 中部署 SharePoint 復原伺服器陣列</span><span class="sxs-lookup"><span data-stu-id="5ae63-333">Phase 4: Deploy the SharePoint recovery farm in Azure</span></span>

<span data-ttu-id="5ae63-334">根據設計方案，在您的虛擬網路中部署 SharePoint 伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-334">Deploy the SharePoint farm in your Virtual Network according to your design plans.</span></span> <span data-ttu-id="5ae63-335">檢查 azure[基礎結構服務上的 SharePoint 2013](https://go.microsoft.com/fwlink/p/?LinkId=400984) ，以在 azure 中部署 SharePoint 角色之前，可能會有所説明。</span><span class="sxs-lookup"><span data-stu-id="5ae63-335">It might be helpful to review [Planning for SharePoint 2013 on Azure Infrastructure Services](https://go.microsoft.com/fwlink/p/?LinkId=400984) before you deploy SharePoint roles in Azure.</span></span>
  
<span data-ttu-id="5ae63-336">請考慮我們透過建立概念證明環境所學到的下列做法：</span><span class="sxs-lookup"><span data-stu-id="5ae63-336">Consider the following practices that we learned by building our proof of concept environment:</span></span>
  
- <span data-ttu-id="5ae63-337">使用 Azure 入口網站或 PowerShell 建立虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="5ae63-337">Create virtual machines by using the Azure portal or PowerShell.</span></span>
    
- <span data-ttu-id="5ae63-338">Azure 和 Hyper-V 不支援動態記憶體。</span><span class="sxs-lookup"><span data-stu-id="5ae63-338">Azure and Hyper-V do not support dynamic memory.</span></span> <span data-ttu-id="5ae63-339">請確定這會考慮您的效能與容量計劃。</span><span class="sxs-lookup"><span data-stu-id="5ae63-339">Be sure this is factored into your performance and capacity plans.</span></span>
    
- <span data-ttu-id="5ae63-340">透過 Azure 介面重新開機虛擬機器，而非來自虛擬機器登入本身。</span><span class="sxs-lookup"><span data-stu-id="5ae63-340">Restart virtual machines through the Azure interface, not from the virtual machine logon itself.</span></span> <span data-ttu-id="5ae63-341">使用 Azure 介面會更好地運作，而且更具可預測性。</span><span class="sxs-lookup"><span data-stu-id="5ae63-341">Using the Azure interface works better and is more predictable.</span></span>
    
- <span data-ttu-id="5ae63-342">如果您想要關閉虛擬機器以節約成本，請使用 Azure 介面。</span><span class="sxs-lookup"><span data-stu-id="5ae63-342">If you want to shut down a virtual machine to save costs, use the Azure interface.</span></span> <span data-ttu-id="5ae63-343">如果您從虛擬機器登入關閉，費用仍會繼續累算。</span><span class="sxs-lookup"><span data-stu-id="5ae63-343">If you shut down from the virtual machine logon, charges continue to accrue.</span></span>
    
- <span data-ttu-id="5ae63-344">使用虛擬機器的命名慣例。</span><span class="sxs-lookup"><span data-stu-id="5ae63-344">Use a naming convention for the virtual machines.</span></span>
    
- <span data-ttu-id="5ae63-345">請留意虛擬機器部署所在的資料中心位置。</span><span class="sxs-lookup"><span data-stu-id="5ae63-345">Pay attention to which datacenter location the virtual machines are being deployed.</span></span>
    
- <span data-ttu-id="5ae63-346">SharePoint 角色不支援 Azure 中的自動縮放功能。</span><span class="sxs-lookup"><span data-stu-id="5ae63-346">The automatic scaling feature in Azure is not supported for SharePoint roles.</span></span>
    
- <span data-ttu-id="5ae63-347">請勿在伺服器陣列中設定將要還原的專案，例如網站集合。</span><span class="sxs-lookup"><span data-stu-id="5ae63-347">Do not configure items in the farm that will be restored, such as site collections.</span></span> 
    
## <a name="phase-5-set-up-dfsr-between-the-farms"></a><span data-ttu-id="5ae63-348">階段5：設定伺服器陣列之間的 DFSR</span><span class="sxs-lookup"><span data-stu-id="5ae63-348">Phase 5: Set up DFSR between the farms</span></span>

<span data-ttu-id="5ae63-349">若要使用 DFSR 設定檔複寫，請使用 DNS 管理嵌入式管理單元。</span><span class="sxs-lookup"><span data-stu-id="5ae63-349">To set up file replication by using DFSR, use the DNS Management snap-in.</span></span> <span data-ttu-id="5ae63-350">不過，在 DFSR 設定之前，請登入您的內部部署檔案伺服器和 Azure 檔案伺服器，並啟用 Windows 中的服務。</span><span class="sxs-lookup"><span data-stu-id="5ae63-350">However, before the DFSR setup, log on to your on-premises file server and Azure file server and enable the service in Windows.</span></span>
  
<span data-ttu-id="5ae63-351">在 [伺服器管理員] 儀表板中，完成下列步驟：</span><span class="sxs-lookup"><span data-stu-id="5ae63-351">From the Server Manager Dashboard, complete the following steps:</span></span>
  
- <span data-ttu-id="5ae63-352">設定本機伺服器。</span><span class="sxs-lookup"><span data-stu-id="5ae63-352">Configure the local server.</span></span>
    
- <span data-ttu-id="5ae63-353">啟動 [**新增角色及功能] 嚮導**。</span><span class="sxs-lookup"><span data-stu-id="5ae63-353">Start the **Add Roles and Features Wizard**.</span></span>
    
- <span data-ttu-id="5ae63-354">開啟 [檔案**及儲存體服務**] 節點。</span><span class="sxs-lookup"><span data-stu-id="5ae63-354">Open the **File and Storage Services** node.</span></span>
    
- <span data-ttu-id="5ae63-355">選取 [ **Dfs 命名空間**及**dfs**複寫]。</span><span class="sxs-lookup"><span data-stu-id="5ae63-355">Select **DFS Namespaces** and **DFS replication**.</span></span>
    
- <span data-ttu-id="5ae63-356">按 **[下一步**] 完成嚮導的步驟。</span><span class="sxs-lookup"><span data-stu-id="5ae63-356">Click **Next** to finish the wizard steps.</span></span>
    
<span data-ttu-id="5ae63-357">下表提供 DFSR 參考文章和博客文章的連結。</span><span class="sxs-lookup"><span data-stu-id="5ae63-357">The following table provides links to DFSR reference articles and blog posts.</span></span>
  
<span data-ttu-id="5ae63-358">**表： DFSR 的參考文章**</span><span class="sxs-lookup"><span data-stu-id="5ae63-358">**Table: Reference articles for DFSR**</span></span>

|<span data-ttu-id="5ae63-359">**標題**</span><span class="sxs-lookup"><span data-stu-id="5ae63-359">**Title**</span></span>|<span data-ttu-id="5ae63-360">**描述**</span><span class="sxs-lookup"><span data-stu-id="5ae63-360">**Description**</span></span>|
|:-----|:-----|
|[<span data-ttu-id="5ae63-361">複製</span><span class="sxs-lookup"><span data-stu-id="5ae63-361">Replication</span></span>](https://go.microsoft.com/fwlink/p/?LinkId=392732) <br/> |<span data-ttu-id="5ae63-362">具有複寫連結的 DFS 管理 TechNet 主題</span><span class="sxs-lookup"><span data-stu-id="5ae63-362">DFS Management TechNet topic with links for replication</span></span>  <br/> |
|[<span data-ttu-id="5ae63-363">DFS 複寫：倖存指南</span><span class="sxs-lookup"><span data-stu-id="5ae63-363">DFS Replication: Survival Guide</span></span>](https://go.microsoft.com/fwlink/p/?LinkId=392737) <br/> |<span data-ttu-id="5ae63-364">包含 DFS 資訊連結的 Wiki</span><span class="sxs-lookup"><span data-stu-id="5ae63-364">Wiki with links to DFS information</span></span>  <br/> |
|[<span data-ttu-id="5ae63-365">DFS 複寫：常見問題</span><span class="sxs-lookup"><span data-stu-id="5ae63-365">DFS Replication: Frequently Asked Questions</span></span>](https://go.microsoft.com/fwlink/p/?LinkId=392738) <br/> |<span data-ttu-id="5ae63-366">DFS 複寫 TechNet 主題</span><span class="sxs-lookup"><span data-stu-id="5ae63-366">DFS Replication TechNet topic</span></span>  <br/> |
|[<span data-ttu-id="5ae63-367">聖約瑟 Barreto 的博客</span><span class="sxs-lookup"><span data-stu-id="5ae63-367">Jose Barreto's Blog</span></span>](https://go.microsoft.com/fwlink/p/?LinkId=392739) <br/> |<span data-ttu-id="5ae63-368">Microsoft 的檔案伺服器小組主要程式管理員撰寫的博客</span><span class="sxs-lookup"><span data-stu-id="5ae63-368">Blog written by a Principal Program Manager on the File Server team at Microsoft</span></span>  <br/> |
|[<span data-ttu-id="5ae63-369">Microsoft 檔案檔案櫃博客的儲存小組</span><span class="sxs-lookup"><span data-stu-id="5ae63-369">The Storage Team at Microsoft - File Cabinet Blog</span></span>](https://go.microsoft.com/fwlink/p/?LinkId=392740) <br/> |<span data-ttu-id="5ae63-370">有關 Windows Server 中檔服務和儲存功能的博客</span><span class="sxs-lookup"><span data-stu-id="5ae63-370">Blog about file services and storage features in Windows Server</span></span>  <br/> |
   
## <a name="phase-6-set-up-log-shipping-to-the-recovery-farm"></a><span data-ttu-id="5ae63-371">階段6：設定對復原伺服器陣列的記錄傳送</span><span class="sxs-lookup"><span data-stu-id="5ae63-371">Phase 6: Set up log shipping to the recovery farm</span></span>

<span data-ttu-id="5ae63-372">「記錄傳送」是在此環境中設定嚴重損壞修復的重要元件。</span><span class="sxs-lookup"><span data-stu-id="5ae63-372">Log shipping is the critical component for setting up disaster recovery in this environment.</span></span> <span data-ttu-id="5ae63-373">您可以使用記錄傳送，將資料庫的交易記錄檔從主要資料庫伺服器實例自動傳送至輔助資料庫伺服器實例。</span><span class="sxs-lookup"><span data-stu-id="5ae63-373">You can use log shipping to automatically send transaction log files for databases from a primary database server instance to a secondary database server instance.</span></span> <span data-ttu-id="5ae63-374">若要設定記錄傳送，請參閱[在 2013 SharePoint 中設定記錄傳送](https://docs.microsoft.com/sharepoint/administration/configure-log-shipping)。</span><span class="sxs-lookup"><span data-stu-id="5ae63-374">To set up log shipping, see [Configure log shipping in SharePoint 2013](https://docs.microsoft.com/sharepoint/administration/configure-log-shipping).</span></span> 
  
> [!IMPORTANT]
> <span data-ttu-id="5ae63-375">SharePoint Server 中的記錄傳送支援僅限特定資料庫。</span><span class="sxs-lookup"><span data-stu-id="5ae63-375">Log shipping support in SharePoint Server is limited to certain databases.</span></span> <span data-ttu-id="5ae63-376">如需詳細資訊，請參閱[SharePoint 資料庫支援的高可用性和嚴重損壞修復選項（SharePoint 2013）](https://go.microsoft.com/fwlink/p/?LinkId=393121)。</span><span class="sxs-lookup"><span data-stu-id="5ae63-376">For more information, see [Supported high availability and disaster recovery options for SharePoint databases (SharePoint 2013)](https://go.microsoft.com/fwlink/p/?LinkId=393121).</span></span> 
  
## <a name="phase-7-validate-failover-and-recovery"></a><span data-ttu-id="5ae63-377">階段7：驗證容錯移轉和復原</span><span class="sxs-lookup"><span data-stu-id="5ae63-377">Phase 7: Validate failover and recovery</span></span>

<span data-ttu-id="5ae63-378">此項最後階段的目的是驗證嚴重損壞修復解決方案的運作方式是否為已計畫。</span><span class="sxs-lookup"><span data-stu-id="5ae63-378">The goal of this final phase is to verify that the disaster recovery solution works as planned.</span></span> <span data-ttu-id="5ae63-379">若要這麼做，請建立容錯移轉事件，以關閉實際執行伺服器陣列，並以取代的方式啟動復原伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-379">To do this, create a failover event that shuts down the production farm and starts up the recovery farm as a replacement.</span></span> <span data-ttu-id="5ae63-380">您可以手動或透過使用腳本來啟動容錯移轉案例。</span><span class="sxs-lookup"><span data-stu-id="5ae63-380">You can start a failover scenario manually or by using scripts.</span></span>
  
<span data-ttu-id="5ae63-381">第一步是停止傳入的使用者伺服器陣列服務或內容的要求。</span><span class="sxs-lookup"><span data-stu-id="5ae63-381">The first step is to stop incoming user requests for farm services or content.</span></span> <span data-ttu-id="5ae63-382">若要執行此動作，您可以停用 DNS 專案或關閉前端網頁伺服器。</span><span class="sxs-lookup"><span data-stu-id="5ae63-382">You can do this by disabling DNS entries or by shutting down the front-end web servers.</span></span> <span data-ttu-id="5ae63-383">伺服器陣列 "停機" 後，您就可以容錯移轉至復原伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-383">After the farm is "down," you can fail over to the recovery farm.</span></span>
  
### <a name="stop-log-shipping"></a><span data-ttu-id="5ae63-384">停止記錄傳送</span><span class="sxs-lookup"><span data-stu-id="5ae63-384">Stop log shipping</span></span>

<span data-ttu-id="5ae63-385">在伺服器陣列復原之前，您必須停止記錄傳送。</span><span class="sxs-lookup"><span data-stu-id="5ae63-385">You must stop log shipping before farm recovery.</span></span> <span data-ttu-id="5ae63-386">請先停止 Azure 中次要伺服器上的記錄傳送，然後再將它停止在內部部署的主伺服器上。</span><span class="sxs-lookup"><span data-stu-id="5ae63-386">Stop log shipping on the secondary server in Azure first, and then stop it on the primary server on-premises.</span></span> <span data-ttu-id="5ae63-387">在第一部伺服器上，使用下列腳本停止記錄傳送，然後再停止主伺服器上的記錄傳送。</span><span class="sxs-lookup"><span data-stu-id="5ae63-387">Use the following script to stop log shipping on the secondary server first and then on the primary server.</span></span> <span data-ttu-id="5ae63-388">腳本中的資料庫名稱可能會不同，這要視您的環境而定。</span><span class="sxs-lookup"><span data-stu-id="5ae63-388">The database names in the script might be different, depending on your environment.</span></span>
  
```
-- This script removes log shipping from the server.
-- Commands must be executed on the secondary server first and then on the primary server.

SET NOCOUNT ON
DECLARE  @PriDB nvarchar(max)
,@SecDB nvarchar(250)
,@PriSrv nvarchar(250)
,@SecSrv nvarchar(250)

Set @PriDB= ''
SET @PriDB = UPPER(@PriDB)
SET @PriDB = REPLACE(@PriDB, ' ', '')
SET @PriDB = '''' + REPLACE(@PriDB, ',', ''', ''') + ''''

Set @SecDB = @PriDB

Exec ( 'Select  ''exec master..sp_delete_log_shipping_secondary_database '' + '''''''' + prm.primary_database +  ''''''''   
from msdb.dbo.log_shipping_monitor_primary prm INNER JOIN msdb.dbo.log_shipping_primary_secondaries sec  ON  prm.primary_database=sec.secondary_database
where prm.primary_database in ( ' + @PriDB + ' )')

Exec ( 'Select  ''exec master..sp_delete_log_shipping_primary_secondary '' + '''''''' + prm.Primary_Database + '''''', '''''' + sec.Secondary_Server + '''''', '''''' + sec.Secondary_database + ''''''''   
from msdb.dbo.log_shipping_monitor_primary prm INNER JOIN msdb.dbo.log_shipping_primary_secondaries sec  ON  prm.primary_database=sec.secondary_database
where prm.primary_database in ( ' + @PriDB + ' )')

Exec ( 'Select  ''exec master..sp_delete_log_shipping_primary_database '' + '''''''' + prm.primary_database +  ''''''''   
from msdb.dbo.log_shipping_monitor_primary prm INNER JOIN msdb.dbo.log_shipping_primary_secondaries sec  ON  prm.primary_database=sec.secondary_database
where prm.primary_database in ( ' + @PriDB + ' )')

Exec ( 'Select  ''exec master..sp_delete_log_shipping_secondary_primary '' + '''''''' + prm.primary_server + '''''', '''''' + prm.primary_database +  ''''''''   
from msdb.dbo.log_shipping_monitor_primary prm INNER JOIN msdb.dbo.log_shipping_primary_secondaries sec  ON  prm.primary_database=sec.secondary_database
where prm.primary_database in ( ' + @PriDB + ' )')

```

### <a name="restore-the-backups"></a><span data-ttu-id="5ae63-389">還原備份</span><span class="sxs-lookup"><span data-stu-id="5ae63-389">Restore the backups</span></span>

<span data-ttu-id="5ae63-390">備份必須以建立的順序還原。</span><span class="sxs-lookup"><span data-stu-id="5ae63-390">Backups must be restored in the order in which they were created.</span></span> <span data-ttu-id="5ae63-391">在還原特定的交易記錄檔備份之前，必須先還原下列先前的備份，而不會回退未提交的交易（也就是使用 `WITH NORECOVERY` ）：</span><span class="sxs-lookup"><span data-stu-id="5ae63-391">Before you can restore a particular transaction log backup, you must first restore the following previous backups without rolling back uncommitted transactions (that is, by using  `WITH NORECOVERY`):</span></span>
  
- <span data-ttu-id="5ae63-392">完整資料庫備份及最後一個差異備份-還原這些備份（若有的話），在特定交易記錄備份之前進行。</span><span class="sxs-lookup"><span data-stu-id="5ae63-392">The full database backup and the last differential backup - Restore these backups, if any exist, taken before the particular transaction log backup.</span></span> <span data-ttu-id="5ae63-393">在建立最近的完整資料庫備份或差異資料庫備份之前，資料庫使用的是完整復原模式或大容量記錄復原模式。</span><span class="sxs-lookup"><span data-stu-id="5ae63-393">Before the most recent full or differential database backup was created, the database was using the full recovery model or bulk-logged recovery model.</span></span>
    
- <span data-ttu-id="5ae63-394">所有交易記錄檔備份-還原完整資料庫備份或差異備份之後所進行的任何交易記錄備份（如果您還原一個）和特定的交易記錄備份。</span><span class="sxs-lookup"><span data-stu-id="5ae63-394">All transaction log backups - Restore any transaction log backups taken after the full database backup or the differential backup (if you restore one) and before the particular transaction log backup.</span></span> <span data-ttu-id="5ae63-395">記錄備份必須依其建立的順序套用，不含記錄鏈中的任何間隙。</span><span class="sxs-lookup"><span data-stu-id="5ae63-395">Log backups must be applied in the sequence in which they were created, without any gaps in the log chain.</span></span>
    
<span data-ttu-id="5ae63-396">若要復原次要伺服器上的內容資料庫，讓網站能夠轉譯，請在復原之前移除所有資料庫連線。</span><span class="sxs-lookup"><span data-stu-id="5ae63-396">To recover the content database on the secondary server so that the sites render, remove all database connections before recovery.</span></span> <span data-ttu-id="5ae63-397">若要還原資料庫，請執行下列 SQL 語句。</span><span class="sxs-lookup"><span data-stu-id="5ae63-397">To restore the database, run the following SQL statement.</span></span>
  
```
restore database WSS_Content with recovery

```

> [!IMPORTANT]
> <span data-ttu-id="5ae63-398">當您明確使用 T-SQL 時，請在每個 RESTORE 語句中指定**WITH NORECOVERY** OR **with RECOVERY** ，以消除多義性，這在撰寫腳本時非常重要。</span><span class="sxs-lookup"><span data-stu-id="5ae63-398">When you use T-SQL explicitly, specify either **WITH NORECOVERY** or **WITH RECOVERY** in every RESTORE statement to eliminate ambiguity—this is very important when writing scripts.</span></span> <span data-ttu-id="5ae63-399">還原完整和差異備份後，可在 SQL Server Management Studio 中還原交易記錄。</span><span class="sxs-lookup"><span data-stu-id="5ae63-399">After the full and differential backups are restored, the transaction logs can be restored in SQL Server Management Studio.</span></span> <span data-ttu-id="5ae63-400">此外，因為已停止記錄傳送，所以內容資料庫處於待機狀態，所以您必須將狀態變更為 [完整存取]。</span><span class="sxs-lookup"><span data-stu-id="5ae63-400">Also, because log shipping is already stopped, the content database is in a standby state, so you must change the state to full access.</span></span>
  
<span data-ttu-id="5ae63-401">在 SQL Server Management Studio 中，以滑鼠右鍵按一下**WSS_Content**資料庫，指向 [**任務**  >  **還原**]，然後按一下 [**交易記錄**] （如果尚未還原完整備份，這是無法使用）。</span><span class="sxs-lookup"><span data-stu-id="5ae63-401">In SQL Server Management Studio, right-click the **WSS_Content** database, point to **Tasks** > **Restore**, and then click **Transaction Log** (if you have not restored the full backup, this is not available).</span></span> <span data-ttu-id="5ae63-402">如需詳細資訊，請參閱[還原交易記錄備份（SQL Server）](https://go.microsoft.com/fwlink/p/?LinkId=392778)。</span><span class="sxs-lookup"><span data-stu-id="5ae63-402">For more information, see[Restore a Transaction Log Backup (SQL Server)](https://go.microsoft.com/fwlink/p/?LinkId=392778).</span></span>
  
### <a name="crawl-the-content-source"></a><span data-ttu-id="5ae63-403">編目內容來源</span><span class="sxs-lookup"><span data-stu-id="5ae63-403">Crawl the content source</span></span>

<span data-ttu-id="5ae63-404">您必須啟動每個內容來源的完整編目，才可還原搜尋服務。</span><span class="sxs-lookup"><span data-stu-id="5ae63-404">You must start a full crawl for each content source to restore the Search Service.</span></span> <span data-ttu-id="5ae63-405">請注意，您會失去來自內部部署伺服器陣列的某些分析資訊，例如搜尋建議。</span><span class="sxs-lookup"><span data-stu-id="5ae63-405">Note that you lose some analytics information from the on-premises farm, such as search recommendations.</span></span> <span data-ttu-id="5ae63-406">在您開始完整編目之前，請使用 Windows PowerShell Cmdlet **Restore-SPEnterpriseSearchServiceApplication** ，並指定記錄傳送及複寫的搜尋管理資料庫， \*\*Search_Service__DB_ <GUID> \*\*。</span><span class="sxs-lookup"><span data-stu-id="5ae63-406">Before you start the full crawls, use the Windows PowerShell cmdlet **Restore-SPEnterpriseSearchServiceApplication** and specify the log-shipped and replicated Search Administration database, **Search_Service__DB_<GUID>**.</span></span> <span data-ttu-id="5ae63-407">此 Cmdlet 會提供搜尋設定、架構、managed 屬性、規則和來源，並建立其他元件的預設集合。</span><span class="sxs-lookup"><span data-stu-id="5ae63-407">This cmdlet gives the search configuration, schema, managed properties, rules, and sources and creates a default set of the other components.</span></span>
  
<span data-ttu-id="5ae63-408">若要開始完整編目，請完成下列步驟：</span><span class="sxs-lookup"><span data-stu-id="5ae63-408">To start a full crawl, complete the following steps:</span></span>
  
1. <span data-ttu-id="5ae63-409">在 SharePoint 2013 管理中心中，移至**應用程式管理**  >  **服務應用程式**  >  **管理服務應用**程式，然後按一下您要編目的 Search Service 應用程式。</span><span class="sxs-lookup"><span data-stu-id="5ae63-409">In the SharePoint 2013 Central Administration, go to **Application Management** > **Service Applications** > **Manage service applications**, and then click the Search Service application that you want to crawl.</span></span>
    
2. <span data-ttu-id="5ae63-410">在 [**搜尋管理**] 頁面上，按一下 [**內容來源**]，指向您想要的內容來源，按一下箭號，然後按一下 [**啟動完整**編目]。</span><span class="sxs-lookup"><span data-stu-id="5ae63-410">On the **Search Administration** page, click **Content Sources**, point to the content source that you want, click the arrow, and then click **Start Full Crawl**.</span></span>
    
### <a name="recover-farm-services"></a><span data-ttu-id="5ae63-411">復原伺服器陣列服務</span><span class="sxs-lookup"><span data-stu-id="5ae63-411">Recover farm services</span></span>

<span data-ttu-id="5ae63-412">下表顯示如何復原具有記錄傳送資料庫的服務、具有資料庫但不建議使用記錄傳送還原的服務，以及沒有資料庫的服務。</span><span class="sxs-lookup"><span data-stu-id="5ae63-412">The following table shows how to recover services that have log-shipped databases, the services that have databases but are not recommended to restore with log shipping, and the services that do not have databases.</span></span>
  
> [!IMPORTANT]
> <span data-ttu-id="5ae63-413">將內部部署 SharePoint 資料庫還原到 Azure 環境中，不會復原您在 Azure 中已手動安裝的任何 SharePoint 服務。</span><span class="sxs-lookup"><span data-stu-id="5ae63-413">Restoring an on-premises SharePoint database into the Azure environment will not recover any SharePoint services that you did not already install in Azure manually.</span></span> 
  
<span data-ttu-id="5ae63-414">**表：服務應用程式資料庫參考**</span><span class="sxs-lookup"><span data-stu-id="5ae63-414">**Table: Service application database reference**</span></span>

|<span data-ttu-id="5ae63-415">**從記錄傳送的資料庫還原這些服務**</span><span class="sxs-lookup"><span data-stu-id="5ae63-415">**Restore these services from log-shipped databases**</span></span>|<span data-ttu-id="5ae63-416">**這些服務具有資料庫，但建議您在不還原其資料庫的情況下啟動這些服務**</span><span class="sxs-lookup"><span data-stu-id="5ae63-416">**These services have databases, but we recommend that you start these services without restoring their databases**</span></span>|<span data-ttu-id="5ae63-417">**這些服務不會將資料儲存在資料庫中;容錯移轉後啟動這些服務**</span><span class="sxs-lookup"><span data-stu-id="5ae63-417">**These services do not store data in databases; start these services after failover**</span></span>|
|:-----|:-----|:-----|
| <span data-ttu-id="5ae63-418">機器翻譯服務</span><span class="sxs-lookup"><span data-stu-id="5ae63-418">Machine Translation Service</span></span> <br/>  <span data-ttu-id="5ae63-419">Managed Metadata Service</span><span class="sxs-lookup"><span data-stu-id="5ae63-419">Managed Metadata Service</span></span> <br/>  <span data-ttu-id="5ae63-420">Secure Store Service</span><span class="sxs-lookup"><span data-stu-id="5ae63-420">Secure Store Service</span></span> <br/>  <span data-ttu-id="5ae63-421">使用者設定檔。</span><span class="sxs-lookup"><span data-stu-id="5ae63-421">User Profile.</span></span> <span data-ttu-id="5ae63-422">（僅支援設定檔和社交標記資料庫。</span><span class="sxs-lookup"><span data-stu-id="5ae63-422">(Only the Profile and Social Tagging databases are supported.</span></span> <span data-ttu-id="5ae63-423">不支援同步處理資料庫。）</span><span class="sxs-lookup"><span data-stu-id="5ae63-423">The Synchronization database is not supported.)</span></span> <br/>  <span data-ttu-id="5ae63-424">Microsoft SharePoint Foundation 訂閱設定服務</span><span class="sxs-lookup"><span data-stu-id="5ae63-424">Microsoft SharePoint Foundation Subscription Settings Service</span></span> <br/> | <span data-ttu-id="5ae63-425">Usage and Health Data Collection</span><span class="sxs-lookup"><span data-stu-id="5ae63-425">Usage and Health Data Collection</span></span> <br/>  <span data-ttu-id="5ae63-426">狀態服務</span><span class="sxs-lookup"><span data-stu-id="5ae63-426">State service</span></span> <br/>  <span data-ttu-id="5ae63-427">Word automation</span><span class="sxs-lookup"><span data-stu-id="5ae63-427">Word automation</span></span> <br/> | <span data-ttu-id="5ae63-428">Excel Services</span><span class="sxs-lookup"><span data-stu-id="5ae63-428">Excel Services</span></span> <br/>  <span data-ttu-id="5ae63-429">PerformancePoint Services</span><span class="sxs-lookup"><span data-stu-id="5ae63-429">PerformancePoint Services</span></span> <br/>  <span data-ttu-id="5ae63-430">PowerPoint 轉換</span><span class="sxs-lookup"><span data-stu-id="5ae63-430">PowerPoint Conversion</span></span> <br/>  <span data-ttu-id="5ae63-431">Visio Graphics Service</span><span class="sxs-lookup"><span data-stu-id="5ae63-431">Visio Graphics Service</span></span> <br/>  <span data-ttu-id="5ae63-432">Work Management</span><span class="sxs-lookup"><span data-stu-id="5ae63-432">Work Management</span></span> <br/> |
   
<span data-ttu-id="5ae63-433">下列範例顯示如何從資料庫還原 Managed Metadata service。</span><span class="sxs-lookup"><span data-stu-id="5ae63-433">The following example shows how to restore the Managed Metadata service from a database.</span></span>
  
<span data-ttu-id="5ae63-434">這會使用現有的 Managed_Metadata_DB 資料庫。</span><span class="sxs-lookup"><span data-stu-id="5ae63-434">This uses the existing Managed_Metadata_DB database.</span></span> <span data-ttu-id="5ae63-435">此資料庫為記錄傳送，但是在次要伺服器陣列上沒有任何使用中的服務應用程式，因此在服務應用程式就緒後，必須進行連線。</span><span class="sxs-lookup"><span data-stu-id="5ae63-435">This database is log shipped, but there is no active service application on the secondary farm, so it needs to be connected after the service application is in place.</span></span>
  
<span data-ttu-id="5ae63-436">首先，使用 `New-SPMetadataServiceApplication` ，並指定 `DatabaseName` 具有還原資料庫名稱的參數。</span><span class="sxs-lookup"><span data-stu-id="5ae63-436">First, use  `New-SPMetadataServiceApplication`, and specify the  `DatabaseName` switch with the name of the restored database.</span></span>
  
<span data-ttu-id="5ae63-437">接下來，在次要伺服器上設定新的 Managed Metadata Service 應用程式，如下所示：</span><span class="sxs-lookup"><span data-stu-id="5ae63-437">Next, configure the new Managed Metadata Service Application on the secondary server, as follows:</span></span>
  
- <span data-ttu-id="5ae63-438">名稱： Managed Metadata Service</span><span class="sxs-lookup"><span data-stu-id="5ae63-438">Name: Managed Metadata Service</span></span>
    
- <span data-ttu-id="5ae63-439">資料庫伺服器：已運送交易記錄檔中的資料庫名稱</span><span class="sxs-lookup"><span data-stu-id="5ae63-439">Database server: The database name from the shipped transaction log</span></span>
    
- <span data-ttu-id="5ae63-440">資料庫名稱： Managed_Metadata_DB</span><span class="sxs-lookup"><span data-stu-id="5ae63-440">Database name: Managed_Metadata_DB</span></span>
    
- <span data-ttu-id="5ae63-441">應用程式集區： SharePoint 服務應用程式</span><span class="sxs-lookup"><span data-stu-id="5ae63-441">Application pool: SharePoint Service Applications</span></span> 
    
### <a name="manage-dns-records"></a><span data-ttu-id="5ae63-442">管理 DNS 記錄</span><span class="sxs-lookup"><span data-stu-id="5ae63-442">Manage DNS records</span></span>

<span data-ttu-id="5ae63-443">您必須手動建立 DNS 記錄，以指向您的 SharePoint 伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-443">You must manually create DNS records to point to your SharePoint farm.</span></span>
  
<span data-ttu-id="5ae63-444">在您有多部前端網頁伺服器的情況下，使用 Windows Server 2012 或硬體負載平衡器的網路負載平衡功能，可在伺服器陣列中的 web 前端伺服器間散佈要求。</span><span class="sxs-lookup"><span data-stu-id="5ae63-444">In most cases where you have multiple front-end web servers, it makes sense to take advantage of the Network Load Balancing feature in Windows Server 2012 or a hardware load balancer to distribute requests among the web-front-end servers in your farm.</span></span> <span data-ttu-id="5ae63-445">網路負載平衡也可以將要求散佈至其他伺服器，以協助降低風險，如果其中一部 web 前端伺服器失敗。</span><span class="sxs-lookup"><span data-stu-id="5ae63-445">Network load balancing can also help reduce risk by distributing requests to the other servers if one of your web-front-end servers fails.</span></span> 
  
<span data-ttu-id="5ae63-446">一般來說，當您設定網路負載平衡時，您的叢集會被指派單一 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="5ae63-446">Typically, when you set up network load balancing, your cluster is assigned a single IP address.</span></span> <span data-ttu-id="5ae63-447">接著，您可以在網路的 DNS 提供者中建立指向該叢集的 DNS 主機記錄。</span><span class="sxs-lookup"><span data-stu-id="5ae63-447">You then create a DNS host record in the DNS provider for your network that points to the cluster.</span></span> <span data-ttu-id="5ae63-448">（針對此專案，我們會在 Azure 中放置 DNS 伺服器以進行復原，以防內部部署資料中心失敗。）例如，您可以在 Active Directory 的 DNS 管理員（稱為）中建立 DNS 記錄，以 `https://sharepoint.contoso.com` 指向負載平衡叢集的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="5ae63-448">(For this project, we put a DNS server in Azure for resiliency in case of an on-premises datacenter failure.) For instance, you can create a DNS record, in DNS Manager in Active Directory, for example, called  `https://sharepoint.contoso.com`, that points to the IP address for your load-balanced cluster.</span></span>
  
<span data-ttu-id="5ae63-449">針對您的 SharePoint 伺服器陣列，您可以在外部 DNS 伺服器上，使用用戶端使用的相同 URL （例如 `https://sharepoint.contoso.com` ），在防火牆中的外部 IP 位址，來建立主機記錄。</span><span class="sxs-lookup"><span data-stu-id="5ae63-449">For external access to your SharePoint farm, you can create a host record on an external DNS server with the same URL that clients use on your intranet (for example, `https://sharepoint.contoso.com`) that points to an external IP address in your firewall.</span></span> <span data-ttu-id="5ae63-450">（使用此範例的最佳作法是設定分割 DNS，讓內部 DNS 伺服器對 SharePoint 的伺服器陣列叢集具有權威性 `contoso.com` 和路由要求，而不是將 DNS 要求路由傳送至外部 DNS 伺服器。）然後，您可以將外部 IP 位址對應至內部部署叢集的內部 IP 位址，讓用戶端找到其所要尋找的資源。</span><span class="sxs-lookup"><span data-stu-id="5ae63-450">(A best practice, using this example, is to set up split DNS so that the internal DNS server is authoritative for `contoso.com` and routes requests directly to the SharePoint farm cluster, rather than routing DNS requests to your external DNS server.) You can then map the external IP address to the internal IP address of your on-premises cluster so that clients find the resources they are looking for.</span></span>
  
<span data-ttu-id="5ae63-451">從這裡，您可能會遇到幾個不同的災害復原案例：</span><span class="sxs-lookup"><span data-stu-id="5ae63-451">From here, you might run into a couple of different disaster-recovery scenarios:</span></span>
  
 <span data-ttu-id="5ae63-452">**範例案例：內部部署 SharePoint 伺服器陣列因內部部署 SharePoint 伺服器陣列中的硬體故障而無法使用。**</span><span class="sxs-lookup"><span data-stu-id="5ae63-452">**Example scenario: The on-premises SharePoint farm is unavailable because of hardware failure in the on-premises SharePoint farm.**</span></span> <span data-ttu-id="5ae63-453">在此情況下，在您完成容錯移轉至 Azure SharePoint 伺服器陣列的步驟之後，您可以在復原 SharePoint 伺服器陣列的 web 前端伺服器上設定網路負載平衡，其方式與使用內部部署伺服器陣列的方式相同。</span><span class="sxs-lookup"><span data-stu-id="5ae63-453">In this case, after you have completed the steps for failover to the Azure SharePoint farm, you can configure network load balancing on the recovery SharePoint farm's web-front-end servers, the same way you did with the on-premises farm.</span></span> <span data-ttu-id="5ae63-454">然後，您可以重新導向內部 DNS 提供者中的主機記錄，以指向復原伺服器陣列的叢集 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="5ae63-454">You can then redirect the host record in your internal DNS provider to point to the recovery farm's cluster IP address.</span></span> <span data-ttu-id="5ae63-455">請注意，在重新整理用戶端的快取 DNS 記錄之前，可能需要一些時間，並指向復原伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-455">Note that it can take some time before cached DNS records on clients are refreshed and point to the recovery farm.</span></span>
  
 <span data-ttu-id="5ae63-456">**範例案例：內部部署資料中心完全遺失。**</span><span class="sxs-lookup"><span data-stu-id="5ae63-456">**Example scenario: The on-premises datacenter is lost completely.**</span></span> <span data-ttu-id="5ae63-457">這種情況可能是由於自然災害，例如火災或洪水引起。</span><span class="sxs-lookup"><span data-stu-id="5ae63-457">This scenario might occur due to a natural disaster, such as a fire or flood.</span></span> <span data-ttu-id="5ae63-458">在此情況下，針對企業，您可能會在另一個區域中裝載次要資料中心，以及您的 Azure 子網具有自己的目錄服務和 DNS。</span><span class="sxs-lookup"><span data-stu-id="5ae63-458">In this case, for an enterprise, you would likely have a secondary datacenter hosted in another region as well as your Azure subnet that has its own directory services and DNS.</span></span> <span data-ttu-id="5ae63-459">如先前的嚴重情況，您可以重新導向您的內部和外部 DNS 記錄，以指向 Azure SharePoint 伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-459">As in the previous disaster scenario, you can redirect your internal and external DNS records to point to the Azure SharePoint farm.</span></span> <span data-ttu-id="5ae63-460">另外請注意，DNS 記錄傳播可能需要一些時間。</span><span class="sxs-lookup"><span data-stu-id="5ae63-460">Again, take note that DNS-record propagation can take some time.</span></span>
  
<span data-ttu-id="5ae63-461">如果您使用主機命名型網站集合（如[主機命名型網站集合架構與部署（SharePoint 2013）](https://docs.microsoft.com/SharePoint/administration/host-named-site-collection-architecture-and-deployment)中的建議，您的 SharePoint 伺服器陣列中的 web 應用程式可能會有多個網站集合，且具有唯一的 DNS 名稱（例如 `https://sales.contoso.com` 和 `https://marketing.contoso.com` ）。</span><span class="sxs-lookup"><span data-stu-id="5ae63-461">If you are using host-named site collections, as recommended in [Host-named site collection architecture and deployment (SharePoint 2013)](https://docs.microsoft.com/SharePoint/administration/host-named-site-collection-architecture-and-deployment), you might have several site collections hosted by the same web application in your SharePoint farm, with unique DNS names (for example, `https://sales.contoso.com` and `https://marketing.contoso.com`).</span></span> <span data-ttu-id="5ae63-462">在此情況下，您可以針對每個指向您的叢集 IP 位址的網站集合建立 DNS 記錄。</span><span class="sxs-lookup"><span data-stu-id="5ae63-462">In this case, you can create DNS records for each site collection that point to your cluster IP address.</span></span> <span data-ttu-id="5ae63-463">要求到達您 SharePoint 的 web 前端伺服器後，它們會處理每個要求的路由傳送至適當的網站集合。</span><span class="sxs-lookup"><span data-stu-id="5ae63-463">After a request reaches your SharePoint web-front-end servers, they handle routing each request to the appropriate site collection.</span></span>
  
## <a name="microsoft-proof-of-concept-environment"></a><span data-ttu-id="5ae63-464">Microsoft 概念證明環境</span><span class="sxs-lookup"><span data-stu-id="5ae63-464">Microsoft proof-of-concept environment</span></span>

<span data-ttu-id="5ae63-465">我們為此方案設計及測試了概念證明環境。</span><span class="sxs-lookup"><span data-stu-id="5ae63-465">We designed and tested a proof-of-concept environment for this solution.</span></span> <span data-ttu-id="5ae63-466">測試環境的設計目標是部署及復原我們在客戶環境中所找到的 SharePoint 伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="5ae63-466">The design goal for our test environment was to deploy and recover a SharePoint farm that we might find in a customer environment.</span></span> <span data-ttu-id="5ae63-467">我們進行了數個假設，但我們知道，伺服器陣列必須提供所有現成的功能，而不需要任何自訂。</span><span class="sxs-lookup"><span data-stu-id="5ae63-467">We made several assumptions, but we knew that the farm needed to provide all of the out-of-the-box functionality without any customizations.</span></span> <span data-ttu-id="5ae63-468">拓撲的設計方式是使用來自欄位及產品群組的最佳做法指導方針，以取得高可用性。</span><span class="sxs-lookup"><span data-stu-id="5ae63-468">The topology was designed for high availability by using best practice guidance from the field and product group.</span></span>
  
<span data-ttu-id="5ae63-469">下表說明為內部部署測試環境建立及設定的 Hyper-V 虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="5ae63-469">The following table describes the Hyper-V virtual machines that we created and configured for the on-premises test environment.</span></span>
  
<span data-ttu-id="5ae63-470">**表：內部部署測試的虛擬機器**</span><span class="sxs-lookup"><span data-stu-id="5ae63-470">**Table: Virtual machines for on-premises test**</span></span>

|<span data-ttu-id="5ae63-471">**伺服器名稱**</span><span class="sxs-lookup"><span data-stu-id="5ae63-471">**Server name**</span></span>|<span data-ttu-id="5ae63-472">**角色**</span><span class="sxs-lookup"><span data-stu-id="5ae63-472">**Role**</span></span>|<span data-ttu-id="5ae63-473">**設定**</span><span class="sxs-lookup"><span data-stu-id="5ae63-473">**Configuration**</span></span>|
|:-----|:-----|:-----|
|<span data-ttu-id="5ae63-474">DC1</span><span class="sxs-lookup"><span data-stu-id="5ae63-474">DC1</span></span>  <br/> |<span data-ttu-id="5ae63-475">使用 Active Directory 的網域控制站。</span><span class="sxs-lookup"><span data-stu-id="5ae63-475">Domain controller with Active Directory.</span></span>  <br/> |<span data-ttu-id="5ae63-476">兩個處理器</span><span class="sxs-lookup"><span data-stu-id="5ae63-476">Two processors</span></span>  <br/> <span data-ttu-id="5ae63-477">從 512 MB 到 4 GB 的 RAM</span><span class="sxs-lookup"><span data-stu-id="5ae63-477">From 512 MB through 4 GB of RAM</span></span>  <br/> <span data-ttu-id="5ae63-478">1 x 127 GB 的硬碟</span><span class="sxs-lookup"><span data-stu-id="5ae63-478">1 x 127-GB hard disk</span></span>  <br/> |
|<span data-ttu-id="5ae63-479">RRAS</span><span class="sxs-lookup"><span data-stu-id="5ae63-479">RRAS</span></span>  <br/> |<span data-ttu-id="5ae63-480">使用路由和遠端存取服務（RRAS）角色設定的伺服器。</span><span class="sxs-lookup"><span data-stu-id="5ae63-480">Server configured with the Routing and Remote Access Service (RRAS) role.</span></span>  <br/> |<span data-ttu-id="5ae63-481">兩個處理器</span><span class="sxs-lookup"><span data-stu-id="5ae63-481">Two processors</span></span>  <br/> <span data-ttu-id="5ae63-482">2-8 GB 的 RAM</span><span class="sxs-lookup"><span data-stu-id="5ae63-482">2-8 GB of RAM</span></span>  <br/> <span data-ttu-id="5ae63-483">1 x 127 GB 的硬碟</span><span class="sxs-lookup"><span data-stu-id="5ae63-483">1 x 127-GB hard disk</span></span>  <br/> |
|<span data-ttu-id="5ae63-484">FS1</span><span class="sxs-lookup"><span data-stu-id="5ae63-484">FS1</span></span>  <br/> |<span data-ttu-id="5ae63-485">包含備份共用的檔案伺服器，以及 DFSR 的端點。</span><span class="sxs-lookup"><span data-stu-id="5ae63-485">File server with shares for backups and an end point for DFSR.</span></span>  <br/> |<span data-ttu-id="5ae63-486">四個處理器</span><span class="sxs-lookup"><span data-stu-id="5ae63-486">Four processors</span></span>  <br/> <span data-ttu-id="5ae63-487">2-12 GB 的 RAM</span><span class="sxs-lookup"><span data-stu-id="5ae63-487">2-12 GB of RAM</span></span>  <br/> <span data-ttu-id="5ae63-488">1 x 127 GB 的硬碟</span><span class="sxs-lookup"><span data-stu-id="5ae63-488">1 x 127-GB hard disk</span></span>  <br/> <span data-ttu-id="5ae63-489">1 x 1-TB 硬碟（SAN）</span><span class="sxs-lookup"><span data-stu-id="5ae63-489">1 x 1-TB hard disk (SAN)</span></span>  <br/> <span data-ttu-id="5ae63-490">1 x 750 GB 的硬碟</span><span class="sxs-lookup"><span data-stu-id="5ae63-490">1 x 750-GB hard disk</span></span>  <br/> |
|<span data-ttu-id="5ae63-491">SP-WFE1，SP-WFE2</span><span class="sxs-lookup"><span data-stu-id="5ae63-491">SP-WFE1, SP-WFE2</span></span>  <br/> |<span data-ttu-id="5ae63-492">前端網頁伺服器。</span><span class="sxs-lookup"><span data-stu-id="5ae63-492">Front-end web servers.</span></span>  <br/> |<span data-ttu-id="5ae63-493">四個處理器</span><span class="sxs-lookup"><span data-stu-id="5ae63-493">Four processors</span></span>  <br/> <span data-ttu-id="5ae63-494">16 GB 的 RAM</span><span class="sxs-lookup"><span data-stu-id="5ae63-494">16 GB of RAM</span></span>  <br/> |
|<span data-ttu-id="5ae63-495">SP-APP1，SP-1 APP2，SP-1 APP3</span><span class="sxs-lookup"><span data-stu-id="5ae63-495">SP-APP1, SP-APP2, SP-APP3</span></span>  <br/> |<span data-ttu-id="5ae63-496">應用程式伺服器。</span><span class="sxs-lookup"><span data-stu-id="5ae63-496">Application servers.</span></span>  <br/> |<span data-ttu-id="5ae63-497">四個處理器</span><span class="sxs-lookup"><span data-stu-id="5ae63-497">Four processors</span></span>  <br/> <span data-ttu-id="5ae63-498">2-16 GB 的 RAM</span><span class="sxs-lookup"><span data-stu-id="5ae63-498">2-16 GB of RAM</span></span>  <br/> |
|<span data-ttu-id="5ae63-499">SP-SQL-HA1，SP-SQL-HA2</span><span class="sxs-lookup"><span data-stu-id="5ae63-499">SP-SQL-HA1, SP-SQL-HA2</span></span>  <br/> |<span data-ttu-id="5ae63-500">以 SQL Server 2012 設定的資料庫伺服器 AlwaysOn 可用性群組提供高可用性。</span><span class="sxs-lookup"><span data-stu-id="5ae63-500">Database servers, configured with SQL Server 2012 AlwaysOn availability groups to provide high availability.</span></span> <span data-ttu-id="5ae63-501">這種設定會使用 SP-SQL-HA1 和 SP-SQL-HA2 做為主要和次要複本。</span><span class="sxs-lookup"><span data-stu-id="5ae63-501">This configuration uses SP-SQL-HA1 and SP-SQL-HA2 as the primary and secondary replicas.</span></span>  <br/> |<span data-ttu-id="5ae63-502">四個處理器</span><span class="sxs-lookup"><span data-stu-id="5ae63-502">Four processors</span></span>  <br/> <span data-ttu-id="5ae63-503">2-16 GB 的 RAM</span><span class="sxs-lookup"><span data-stu-id="5ae63-503">2-16 GB of RAM</span></span>  <br/> |
   
<span data-ttu-id="5ae63-504">下表說明為內部部署測試環境的前端網頁伺服器和應用程式伺服器建立及設定的 Hyper-V 虛擬機器的磁片磁碟機設定。</span><span class="sxs-lookup"><span data-stu-id="5ae63-504">The following table describes drive configurations for the Hyper-V virtual machines that we created and configured for the front-end web and application servers for the on-premises test environment.</span></span>
  
<span data-ttu-id="5ae63-505">**表：內部部署測試的前端 Web 和應用程式伺服器的虛擬機器磁碟機需求**</span><span class="sxs-lookup"><span data-stu-id="5ae63-505">**Table: Virtual machine drive requirements for the Front End Web and Application servers for the on-premises test**</span></span>

|<span data-ttu-id="5ae63-506">**磁碟機號**</span><span class="sxs-lookup"><span data-stu-id="5ae63-506">**Drive letter**</span></span>|<span data-ttu-id="5ae63-507">**大小**</span><span class="sxs-lookup"><span data-stu-id="5ae63-507">**Size**</span></span>|<span data-ttu-id="5ae63-508">**目錄名稱**</span><span class="sxs-lookup"><span data-stu-id="5ae63-508">**Directory name**</span></span>|<span data-ttu-id="5ae63-509">**Path**</span><span class="sxs-lookup"><span data-stu-id="5ae63-509">**Path**</span></span>|
|:-----|:-----|:-----|:-----|
|<span data-ttu-id="5ae63-510">C</span><span class="sxs-lookup"><span data-stu-id="5ae63-510">C</span></span>  <br/> |<span data-ttu-id="5ae63-511">80</span><span class="sxs-lookup"><span data-stu-id="5ae63-511">80</span></span>  <br/> |<span data-ttu-id="5ae63-512">系統磁片磁碟機</span><span class="sxs-lookup"><span data-stu-id="5ae63-512">System drive</span></span>  <br/> |<span data-ttu-id="5ae63-513"><DriveLetter>： \\ 程式檔 \\ Microsoft SQL Server</span><span class="sxs-lookup"><span data-stu-id="5ae63-513"><DriveLetter>:\\Program Files\\Microsoft SQL Server</span></span>\\  <br/> |
|<span data-ttu-id="5ae63-514">E</span><span class="sxs-lookup"><span data-stu-id="5ae63-514">E</span></span>  <br/> |<span data-ttu-id="5ae63-515">80</span><span class="sxs-lookup"><span data-stu-id="5ae63-515">80</span></span>  <br/> |<span data-ttu-id="5ae63-516">記錄檔磁片（40 GB）</span><span class="sxs-lookup"><span data-stu-id="5ae63-516">Log drive (40 GB)</span></span>  <br/> |<span data-ttu-id="5ae63-517"><DriveLetter>： \\ Program Files \\ Microsoft SQL Server \\ MSSQL10_50。 MSSQLSERVER \\ MSSQL \\ 資料</span><span class="sxs-lookup"><span data-stu-id="5ae63-517"><DriveLetter>:\\Program Files\\Microsoft SQL Server\\MSSQL10_50.MSSQLSERVER\\MSSQL\\DATA</span></span>  <br/> |
|<span data-ttu-id="5ae63-518">F</span><span class="sxs-lookup"><span data-stu-id="5ae63-518">F</span></span>  <br/> |<span data-ttu-id="5ae63-519">80</span><span class="sxs-lookup"><span data-stu-id="5ae63-519">80</span></span>  <br/> |<span data-ttu-id="5ae63-520">頁面（36 GB）</span><span class="sxs-lookup"><span data-stu-id="5ae63-520">Page (36 GB)</span></span>  <br/> |<span data-ttu-id="5ae63-521"><DriveLetter>： \\ 程式檔 \\ Microsoft SQL Server \\ MSSQL \\ 資料</span><span class="sxs-lookup"><span data-stu-id="5ae63-521"><DriveLetter>:\\Program Files\\Microsoft SQL Server\\MSSQL\\DATA</span></span>  <br/> |
   
<span data-ttu-id="5ae63-522">下表說明建立並設定為內部部署資料庫伺服器的 Hyper-V 虛擬機器的磁片磁碟機設定。</span><span class="sxs-lookup"><span data-stu-id="5ae63-522">The following table describes drive configurations for the Hyper-V virtual machines created and configured to serve as the on-premises database servers.</span></span> <span data-ttu-id="5ae63-523">在 [**資料庫引擎**設定] 頁面上，存取 [**資料目錄**] 索引標籤，以設定及確認下表所示的設定。</span><span class="sxs-lookup"><span data-stu-id="5ae63-523">On the **Database Engine Configuration** page, access the **Data Directories** tab to set and confirm the settings shown in the following table.</span></span>
  
<span data-ttu-id="5ae63-524">**表：內部部署測試的資料庫伺服器的虛擬機器磁碟機需求**</span><span class="sxs-lookup"><span data-stu-id="5ae63-524">**Table: Virtual machine drive requirements for the database server for the on-premises test**</span></span>

|<span data-ttu-id="5ae63-525">**磁碟機號**</span><span class="sxs-lookup"><span data-stu-id="5ae63-525">**Drive letter**</span></span>|<span data-ttu-id="5ae63-526">**大小**</span><span class="sxs-lookup"><span data-stu-id="5ae63-526">**Size**</span></span>|<span data-ttu-id="5ae63-527">**目錄名稱**</span><span class="sxs-lookup"><span data-stu-id="5ae63-527">**Directory name**</span></span>|<span data-ttu-id="5ae63-528">**Path**</span><span class="sxs-lookup"><span data-stu-id="5ae63-528">**Path**</span></span>|
|:-----|:-----|:-----|:-----|
|<span data-ttu-id="5ae63-529">C</span><span class="sxs-lookup"><span data-stu-id="5ae63-529">C</span></span>  <br/> |<span data-ttu-id="5ae63-530">80</span><span class="sxs-lookup"><span data-stu-id="5ae63-530">80</span></span>  <br/> |<span data-ttu-id="5ae63-531">資料根目錄</span><span class="sxs-lookup"><span data-stu-id="5ae63-531">Data root directory</span></span>  <br/> |<span data-ttu-id="5ae63-532"><DriveLetter>： \\ 程式檔 \\ Microsoft SQL Server</span><span class="sxs-lookup"><span data-stu-id="5ae63-532"><DriveLetter>:\\Program Files\\Microsoft SQL Server</span></span>\\  <br/> |
|<span data-ttu-id="5ae63-533">E</span><span class="sxs-lookup"><span data-stu-id="5ae63-533">E</span></span>  <br/> |<span data-ttu-id="5ae63-534">500</span><span class="sxs-lookup"><span data-stu-id="5ae63-534">500</span></span>  <br/> |<span data-ttu-id="5ae63-535">使用者資料庫目錄</span><span class="sxs-lookup"><span data-stu-id="5ae63-535">User database directory</span></span>  <br/> |<span data-ttu-id="5ae63-536"><DriveLetter>： \\ Program Files \\ Microsoft SQL Server \\ MSSQL10_50。 MSSQLSERVER \\ MSSQL \\ 資料</span><span class="sxs-lookup"><span data-stu-id="5ae63-536"><DriveLetter>:\\Program Files\\Microsoft SQL Server\\MSSQL10_50.MSSQLSERVER\\MSSQL\\DATA</span></span>  <br/> |
|<span data-ttu-id="5ae63-537">F</span><span class="sxs-lookup"><span data-stu-id="5ae63-537">F</span></span>  <br/> |<span data-ttu-id="5ae63-538">500</span><span class="sxs-lookup"><span data-stu-id="5ae63-538">500</span></span>  <br/> |<span data-ttu-id="5ae63-539">使用者資料庫記錄目錄</span><span class="sxs-lookup"><span data-stu-id="5ae63-539">User database log directory</span></span>  <br/> |<span data-ttu-id="5ae63-540"><DriveLetter>： \\ Program Files \\ Microsoft SQL Server \\ MSSQL10_50。 MSSQLSERVER \\ MSSQL \\ 資料</span><span class="sxs-lookup"><span data-stu-id="5ae63-540"><DriveLetter>:\\Program Files\\Microsoft SQL Server\\MSSQL10_50.MSSQLSERVER\\MSSQL\\DATA</span></span>  <br/> |
|<span data-ttu-id="5ae63-541">G</span><span class="sxs-lookup"><span data-stu-id="5ae63-541">G</span></span>  <br/> |<span data-ttu-id="5ae63-542">500</span><span class="sxs-lookup"><span data-stu-id="5ae63-542">500</span></span>  <br/> |<span data-ttu-id="5ae63-543">Temp DB 目錄</span><span class="sxs-lookup"><span data-stu-id="5ae63-543">Temp DB directory</span></span>  <br/> |<span data-ttu-id="5ae63-544"><DriveLetter>： \\ Program Files \\ Microsoft SQL Server \\ MSSQL10_50。 MSSQLSERVER \\ MSSQL \\ 資料</span><span class="sxs-lookup"><span data-stu-id="5ae63-544"><DriveLetter>:\\Program Files\\Microsoft SQL Server\\MSSQL10_50.MSSQLSERVER\\MSSQL\\DATA</span></span>  <br/> |
|<span data-ttu-id="5ae63-545">H</span><span class="sxs-lookup"><span data-stu-id="5ae63-545">H</span></span>  <br/> |<span data-ttu-id="5ae63-546">500</span><span class="sxs-lookup"><span data-stu-id="5ae63-546">500</span></span>  <br/> |<span data-ttu-id="5ae63-547">Temp DB 記錄目錄</span><span class="sxs-lookup"><span data-stu-id="5ae63-547">Temp DB log directory</span></span>  <br/> |<span data-ttu-id="5ae63-548"><DriveLetter>： \\ Program Files \\ Microsoft SQL Server \\ MSSQL10_50。 MSSQLSERVER \\ MSSQL \\ 資料</span><span class="sxs-lookup"><span data-stu-id="5ae63-548"><DriveLetter>:\\Program Files\\Microsoft SQL Server\\MSSQL10_50.MSSQLSERVER\\MSSQL\\DATA</span></span>  <br/> |
   
### <a name="setting-up-the-test-environment"></a><span data-ttu-id="5ae63-549">設定測試環境</span><span class="sxs-lookup"><span data-stu-id="5ae63-549">Setting up the test environment</span></span>

<span data-ttu-id="5ae63-550">在不同的部署階段中，測試小組通常會在內部部署架構上先進行，然後再于對應的 Azure 環境上進行處理。</span><span class="sxs-lookup"><span data-stu-id="5ae63-550">During the different deployment phases, the test team typically worked on the on-premises architecture first and then on the corresponding Azure environment.</span></span> <span data-ttu-id="5ae63-551">這會反映內部生產伺服器陣列已經執行的一般實際案例。</span><span class="sxs-lookup"><span data-stu-id="5ae63-551">This reflects the general real-world cases where in-house production farms are already running.</span></span> <span data-ttu-id="5ae63-552">更為重要的是，您應該知道目前的實際執行工作量、容量及一般效能。</span><span class="sxs-lookup"><span data-stu-id="5ae63-552">What is even more important is that you should know the current production workload, capacity, and typical performance.</span></span> <span data-ttu-id="5ae63-553">除了建立可滿足業務需求的嚴重損壞復原模式之外，您還應該調整復原伺服器陣列伺服器的大小，以提供最低的服務等級。</span><span class="sxs-lookup"><span data-stu-id="5ae63-553">In addition to building a disaster recovery model that can meet business requirements, you should size the recovery farm servers to deliver a minimum level of service.</span></span> <span data-ttu-id="5ae63-554">在 cold 或暖色待命環境中，復原伺服器陣列通常會比實際執行伺服器陣列小。</span><span class="sxs-lookup"><span data-stu-id="5ae63-554">In a cold or warm standby environment, a recovery farm is typically smaller than a production farm.</span></span> <span data-ttu-id="5ae63-555">在復原伺服器陣列穩定且投入實際執行後，可將伺服器陣列向上及向內擴充，以符合工作負載需求。</span><span class="sxs-lookup"><span data-stu-id="5ae63-555">After the recovery farm is stable and in production, the farm can be scaled up and out to meet workload requirements.</span></span>
  
<span data-ttu-id="5ae63-556">我們已在下列三個階段部署測試環境：</span><span class="sxs-lookup"><span data-stu-id="5ae63-556">We deployed our test environment in the following three phases:</span></span>
  
- <span data-ttu-id="5ae63-557">設定混合式基礎結構</span><span class="sxs-lookup"><span data-stu-id="5ae63-557">Set up the hybrid infrastructure</span></span>
    
- <span data-ttu-id="5ae63-558">布建伺服器</span><span class="sxs-lookup"><span data-stu-id="5ae63-558">Provision the servers</span></span>
    
- <span data-ttu-id="5ae63-559">部署 SharePoint 伺服器陣列</span><span class="sxs-lookup"><span data-stu-id="5ae63-559">Deploy the SharePoint farms</span></span>
    
#### <a name="set-up-the-hybrid-infrastructure"></a><span data-ttu-id="5ae63-560">設定混合式基礎結構</span><span class="sxs-lookup"><span data-stu-id="5ae63-560">Set up the hybrid infrastructure</span></span>

<span data-ttu-id="5ae63-561">此階段涉及為內部部署伺服器陣列和 Azure 中的復原伺服器陣列設定網域環境。</span><span class="sxs-lookup"><span data-stu-id="5ae63-561">This phase involved setting up a domain environment for the on-premises farm and for the recovery farm in Azure.</span></span> <span data-ttu-id="5ae63-562">除了與設定 Active Directory 相關的一般工作之外，測試小組還會在兩個環境間執行路由解決方案和 VPN 連線。</span><span class="sxs-lookup"><span data-stu-id="5ae63-562">In addition to the normal tasks associated with configuring Active Directory, the test team implemented a routing solution and a VPN connection between the two environments.</span></span>
  
#### <a name="provision-the-servers"></a><span data-ttu-id="5ae63-563">布建伺服器</span><span class="sxs-lookup"><span data-stu-id="5ae63-563">Provision the servers</span></span>

<span data-ttu-id="5ae63-564">除了伺服器陣列的伺服器之外，還需要布建網域控制站的伺服器，並設定伺服器來處理 RRAS，以及網站對網站的 VPN。</span><span class="sxs-lookup"><span data-stu-id="5ae63-564">In addition to the farm servers, it was necessary to provision servers for the domain controllers and configure a server to handle RRAS as well as the site-to-site VPN.</span></span> <span data-ttu-id="5ae63-565">已布建了 DFSR 服務的兩個檔案伺服器，並且為測試人員布建了許多用戶端電腦。</span><span class="sxs-lookup"><span data-stu-id="5ae63-565">Two file servers were provisioned for the DFSR service, and several client computers were provisioned for testers.</span></span>
  
#### <a name="deploy-the-sharepoint-farms"></a><span data-ttu-id="5ae63-566">部署 SharePoint 伺服器陣列</span><span class="sxs-lookup"><span data-stu-id="5ae63-566">Deploy the SharePoint farms</span></span>

<span data-ttu-id="5ae63-567">SharePoint 伺服器陣列是以兩個階段進行部署，以簡化環境穩定化及疑難排解（如有必要）。</span><span class="sxs-lookup"><span data-stu-id="5ae63-567">The SharePoint farms were deployed in two stages in order to simplify environment stabilization and troubleshooting, if required.</span></span> <span data-ttu-id="5ae63-568">在第一個階段中，每個伺服器陣列都是針對拓撲的各層級的伺服器上的最低數目部署，以支援必要的功能。</span><span class="sxs-lookup"><span data-stu-id="5ae63-568">During the first stage, each farm was deployed on the minimum number of servers for each tier of the topology to support the required functionality.</span></span>
  
<span data-ttu-id="5ae63-569">在建立 SharePoint 2013 伺服器之前，我們會建立安裝了 SQL Server 的資料庫伺服器。</span><span class="sxs-lookup"><span data-stu-id="5ae63-569">We created the database servers with SQL Server installed before creating the SharePoint 2013 servers.</span></span> <span data-ttu-id="5ae63-570">由於這是新的部署，因此我們先建立可用性群組，再部署 SharePoint。</span><span class="sxs-lookup"><span data-stu-id="5ae63-570">Because this was a new deployment, we created the availability groups before deploying SharePoint.</span></span> <span data-ttu-id="5ae63-571">我們會根據 MCS 最佳做法指導方針建立三個群組。</span><span class="sxs-lookup"><span data-stu-id="5ae63-571">We created three groups based on MCS best practice guidance.</span></span> 
  
> [!NOTE]
> <span data-ttu-id="5ae63-572">建立預留位置資料庫，這樣您就可以在安裝 SharePoint 之前建立可用性群組。</span><span class="sxs-lookup"><span data-stu-id="5ae63-572">Create placeholder databases so that you can create availability groups before the SharePoint installation.</span></span> <span data-ttu-id="5ae63-573">如需詳細資訊，請參閱[CONFIGURE SQL Server 2012 AlwaysOn Availability Groups for SharePoint 2013](https://go.microsoft.com/fwlink/p/?LinkId=517626)</span><span class="sxs-lookup"><span data-stu-id="5ae63-573">For more information, see [Configure SQL Server 2012 AlwaysOn Availability Groups for SharePoint 2013](https://go.microsoft.com/fwlink/p/?LinkId=517626)</span></span>
  
<span data-ttu-id="5ae63-574">我們依下列順序建立伺服器陣列及加入其他伺服器：</span><span class="sxs-lookup"><span data-stu-id="5ae63-574">We created the farm and joined additional servers in the following order:</span></span>
  
- <span data-ttu-id="5ae63-575">布建 SP-SQL-HA1 和 SP-SQL-HA2。</span><span class="sxs-lookup"><span data-stu-id="5ae63-575">Provision SP-SQL-HA1 and SP-SQL-HA2.</span></span>
    
- <span data-ttu-id="5ae63-576">設定 AlwaysOn，並為伺服器陣列建立三個可用性群組。</span><span class="sxs-lookup"><span data-stu-id="5ae63-576">Configure AlwaysOn and create the three availability groups for the farm.</span></span> 
    
- <span data-ttu-id="5ae63-577">布建主控管理中心的 SP-APP1。</span><span class="sxs-lookup"><span data-stu-id="5ae63-577">Provision SP-APP1 to host Central Administration.</span></span>
    
- <span data-ttu-id="5ae63-578">布建 SP-WFE1 和 SP-WFE2 以主控分散式快取。</span><span class="sxs-lookup"><span data-stu-id="5ae63-578">Provision SP-WFE1 and SP-WFE2 to host the distributed cache.</span></span> 
    
<span data-ttu-id="5ae63-579">我們在命令列上執行**psconfig.exe**時使用_skipRegisterAsDistributedCachehost_參數。</span><span class="sxs-lookup"><span data-stu-id="5ae63-579">We used the  _skipRegisterAsDistributedCachehost_ parameter when we ran **psconfig.exe** at the command line.</span></span> <span data-ttu-id="5ae63-580">如需詳細資訊，請參閱[Plan for feed And 分散式快取服務 in SharePoint Server 2013](https://docs.microsoft.com/sharepoint/administration/plan-for-feeds-and-the-distributed-cache-service)。</span><span class="sxs-lookup"><span data-stu-id="5ae63-580">For more information, see [Plan for feeds and the Distributed Cache service in SharePoint Server 2013](https://docs.microsoft.com/sharepoint/administration/plan-for-feeds-and-the-distributed-cache-service).</span></span> 
  
<span data-ttu-id="5ae63-581">我們在復原環境中重複下列步驟：</span><span class="sxs-lookup"><span data-stu-id="5ae63-581">We repeated the following steps in the recovery environment:</span></span>
  
- <span data-ttu-id="5ae63-582">布建 AZ-SQL-HA1 和 AZ SQL-HA2。</span><span class="sxs-lookup"><span data-stu-id="5ae63-582">Provision AZ-SQL-HA1 and AZ-SQL-HA2.</span></span>
    
- <span data-ttu-id="5ae63-583">設定 AlwaysOn，並為伺服器陣列建立三個可用性群組。</span><span class="sxs-lookup"><span data-stu-id="5ae63-583">Configure AlwaysOn and create the three availability groups for the farm.</span></span>
    
- <span data-ttu-id="5ae63-584">提供 AZ-APP1 以主控管理中心。</span><span class="sxs-lookup"><span data-stu-id="5ae63-584">Provision AZ-APP1 to host Central Administration.</span></span>
    
- <span data-ttu-id="5ae63-585">布建 AZ-WFE1 和 WFE2 以主控分散式快取。</span><span class="sxs-lookup"><span data-stu-id="5ae63-585">Provision AZ-WFE1 and AZ-WFE2 to host the distributed cache.</span></span>
    
<span data-ttu-id="5ae63-586">設定好分散式快取並新增測試使用者和測試內容之後，我們已開始第二階段的部署。</span><span class="sxs-lookup"><span data-stu-id="5ae63-586">After we configured the distributed cache and added test users and test content, we started stage two of the deployment.</span></span> <span data-ttu-id="5ae63-587">這需要將層級和設定為支援伺服器陣列架構中所述的高可用性拓撲。</span><span class="sxs-lookup"><span data-stu-id="5ae63-587">This required scaling out the tiers and configuring the farm servers to support the high-availability topology described in the farm architecture.</span></span>
  
<span data-ttu-id="5ae63-588">下表說明我們為復原伺服器陣列設定的虛擬機器、子網及可用性設定。</span><span class="sxs-lookup"><span data-stu-id="5ae63-588">The following table describes the virtual machines, subnets, and availability sets we set up for our recovery farm.</span></span>
  
<span data-ttu-id="5ae63-589">**表：復原伺服器陣列基礎結構**</span><span class="sxs-lookup"><span data-stu-id="5ae63-589">**Table: Recovery farm infrastructure**</span></span>

|<span data-ttu-id="5ae63-590">**伺服器名稱**</span><span class="sxs-lookup"><span data-stu-id="5ae63-590">**Server name**</span></span>|<span data-ttu-id="5ae63-591">**角色**</span><span class="sxs-lookup"><span data-stu-id="5ae63-591">**Role**</span></span>|<span data-ttu-id="5ae63-592">**設定**</span><span class="sxs-lookup"><span data-stu-id="5ae63-592">**Configuration**</span></span>|<span data-ttu-id="5ae63-593">**子網路**</span><span class="sxs-lookup"><span data-stu-id="5ae63-593">**Subnet**</span></span>|<span data-ttu-id="5ae63-594">**可用性設定組**</span><span class="sxs-lookup"><span data-stu-id="5ae63-594">**Availability set**</span></span>|
|:-----|:-----|:-----|:-----|:-----|
|<span data-ttu-id="5ae63-595">spDRAD</span><span class="sxs-lookup"><span data-stu-id="5ae63-595">spDRAD</span></span>  <br/> |<span data-ttu-id="5ae63-596">使用 Active Directory 的網域控制站</span><span class="sxs-lookup"><span data-stu-id="5ae63-596">Domain controller with Active Directory</span></span>  <br/> |<span data-ttu-id="5ae63-597">兩個處理器</span><span class="sxs-lookup"><span data-stu-id="5ae63-597">Two processors</span></span>  <br/> <span data-ttu-id="5ae63-598">從 512 MB 到 4 GB 的 RAM</span><span class="sxs-lookup"><span data-stu-id="5ae63-598">From 512 MB through 4 GB of RAM</span></span>  <br/> <span data-ttu-id="5ae63-599">1 x 127 GB 的硬碟</span><span class="sxs-lookup"><span data-stu-id="5ae63-599">1 x 127-GB hard disk</span></span>  <br/> |<span data-ttu-id="5ae63-600">sp-ADservers</span><span class="sxs-lookup"><span data-stu-id="5ae63-600">sp-ADservers</span></span>  <br/> ||
|<span data-ttu-id="5ae63-601">AZ-SP-FS</span><span class="sxs-lookup"><span data-stu-id="5ae63-601">AZ-SP-FS</span></span>  <br/> |<span data-ttu-id="5ae63-602">含備份共用及 DFSR 端點的檔案伺服器</span><span class="sxs-lookup"><span data-stu-id="5ae63-602">File server with shares for backups and an endpoint for DFSR</span></span>  <br/> | <span data-ttu-id="5ae63-603">A5 設定：</span><span class="sxs-lookup"><span data-stu-id="5ae63-603">A5 configuration:</span></span> <br/>  <span data-ttu-id="5ae63-604">兩個處理器</span><span class="sxs-lookup"><span data-stu-id="5ae63-604">Two processors</span></span> <br/>  <span data-ttu-id="5ae63-605">14 GB 的 RAM</span><span class="sxs-lookup"><span data-stu-id="5ae63-605">14 GB of RAM</span></span> <br/>  <span data-ttu-id="5ae63-606">1 x 127 GB 的硬碟</span><span class="sxs-lookup"><span data-stu-id="5ae63-606">1 x 127-GB hard disk</span></span> <br/>  <span data-ttu-id="5ae63-607">1 x 135 GB 的硬碟</span><span class="sxs-lookup"><span data-stu-id="5ae63-607">1 x 135-GB hard disk</span></span> <br/>  <span data-ttu-id="5ae63-608">1 x 127 GB 的硬碟</span><span class="sxs-lookup"><span data-stu-id="5ae63-608">1 x 127-GB hard disk</span></span> <br/>  <span data-ttu-id="5ae63-609">1 x 150 GB 的硬碟</span><span class="sxs-lookup"><span data-stu-id="5ae63-609">1 x 150-GB hard disk</span></span> <br/> |<span data-ttu-id="5ae63-610">sp-databaseservers</span><span class="sxs-lookup"><span data-stu-id="5ae63-610">sp-databaseservers</span></span>  <br/> |<span data-ttu-id="5ae63-611">DATA_SET</span><span class="sxs-lookup"><span data-stu-id="5ae63-611">DATA_SET</span></span>  <br/> |
|<span data-ttu-id="5ae63-612">AZ-WFE1，AZ-WFE2</span><span class="sxs-lookup"><span data-stu-id="5ae63-612">AZ-WFE1, AZ -WFE2</span></span>  <br/> |<span data-ttu-id="5ae63-613">前端網頁伺服器</span><span class="sxs-lookup"><span data-stu-id="5ae63-613">Front End Web servers</span></span>  <br/> | <span data-ttu-id="5ae63-614">A5 設定：</span><span class="sxs-lookup"><span data-stu-id="5ae63-614">A5 configuration:</span></span> <br/>  <span data-ttu-id="5ae63-615">兩個處理器</span><span class="sxs-lookup"><span data-stu-id="5ae63-615">Two processors</span></span> <br/>  <span data-ttu-id="5ae63-616">14 GB 的 RAM</span><span class="sxs-lookup"><span data-stu-id="5ae63-616">14 GB of RAM</span></span> <br/>  <span data-ttu-id="5ae63-617">1 x 127 GB 的硬碟</span><span class="sxs-lookup"><span data-stu-id="5ae63-617">1 x 127-GB hard disk</span></span> <br/> |<span data-ttu-id="5ae63-618">sp-webservers</span><span class="sxs-lookup"><span data-stu-id="5ae63-618">sp-webservers</span></span>  <br/> |<span data-ttu-id="5ae63-619">WFE_SET</span><span class="sxs-lookup"><span data-stu-id="5ae63-619">WFE_SET</span></span>  <br/> |
|<span data-ttu-id="5ae63-620">AZ-APP1，AZ-APP2，AZ-APP3</span><span class="sxs-lookup"><span data-stu-id="5ae63-620">AZ -APP1, AZ -APP2, AZ -APP3</span></span>  <br/> |<span data-ttu-id="5ae63-621">應用程式伺服器</span><span class="sxs-lookup"><span data-stu-id="5ae63-621">Application servers</span></span>  <br/> | <span data-ttu-id="5ae63-622">A5 設定：</span><span class="sxs-lookup"><span data-stu-id="5ae63-622">A5 configuration:</span></span> <br/>  <span data-ttu-id="5ae63-623">兩個處理器</span><span class="sxs-lookup"><span data-stu-id="5ae63-623">Two processors</span></span> <br/>  <span data-ttu-id="5ae63-624">14 GB 的 RAM</span><span class="sxs-lookup"><span data-stu-id="5ae63-624">14 GB of RAM</span></span> <br/>  <span data-ttu-id="5ae63-625">1 x 127 GB 的硬碟</span><span class="sxs-lookup"><span data-stu-id="5ae63-625">1 x 127-GB hard disk</span></span> <br/> |<span data-ttu-id="5ae63-626">sp-applicationservers</span><span class="sxs-lookup"><span data-stu-id="5ae63-626">sp-applicationservers</span></span>  <br/> |<span data-ttu-id="5ae63-627">APP_SET</span><span class="sxs-lookup"><span data-stu-id="5ae63-627">APP_SET</span></span>  <br/> |
|<span data-ttu-id="5ae63-628">AZ-SQL-HA1，AZ SQL-HA2</span><span class="sxs-lookup"><span data-stu-id="5ae63-628">AZ -SQL-HA1, AZ -SQL-HA2</span></span>  <br/> |<span data-ttu-id="5ae63-629">資料庫伺服器及主要和次要複本 AlwaysOn 可用性群組</span><span class="sxs-lookup"><span data-stu-id="5ae63-629">Database servers and primary and secondary replicas for AlwaysOn availability groups</span></span>  <br/> | <span data-ttu-id="5ae63-630">A5 設定：</span><span class="sxs-lookup"><span data-stu-id="5ae63-630">A5 configuration:</span></span> <br/>  <span data-ttu-id="5ae63-631">兩個處理器</span><span class="sxs-lookup"><span data-stu-id="5ae63-631">Two processors</span></span> <br/>  <span data-ttu-id="5ae63-632">14 GB 的 RAM</span><span class="sxs-lookup"><span data-stu-id="5ae63-632">14 GB of RAM</span></span> <br/> |<span data-ttu-id="5ae63-633">sp-databaseservers</span><span class="sxs-lookup"><span data-stu-id="5ae63-633">sp-databaseservers</span></span>  <br/> |<span data-ttu-id="5ae63-634">DATA_SET</span><span class="sxs-lookup"><span data-stu-id="5ae63-634">DATA_SET</span></span>  <br/> |
   
### <a name="operations"></a><span data-ttu-id="5ae63-635">作業</span><span class="sxs-lookup"><span data-stu-id="5ae63-635">Operations</span></span>

<span data-ttu-id="5ae63-636">測試小組穩定了伺服器陣列環境及已完成的功能測試之後，他們會啟動設定內部部署復原環境所需的下列作業工作：</span><span class="sxs-lookup"><span data-stu-id="5ae63-636">After the test team stabilized the farm environments and completed functional testing, they started the following operations tasks required to configure the on-premises recovery environment:</span></span>
  
- <span data-ttu-id="5ae63-637">設定完整和差異備份。</span><span class="sxs-lookup"><span data-stu-id="5ae63-637">Configure full and differential backups.</span></span>
    
- <span data-ttu-id="5ae63-638">在內部部署環境和 Azure 環境之間的檔案伺服器上設定 DFSR，以傳輸交易記錄。</span><span class="sxs-lookup"><span data-stu-id="5ae63-638">Configure DFSR on the file servers that transfer transaction logs between the on-premises environment and the Azure environment.</span></span>
    
- <span data-ttu-id="5ae63-639">在主資料庫伺服器上設定記錄傳送。</span><span class="sxs-lookup"><span data-stu-id="5ae63-639">Configure log shipping on the primary database server.</span></span>
    
- <span data-ttu-id="5ae63-640">視需要進行穩定、驗證及疑難排解記錄傳送。</span><span class="sxs-lookup"><span data-stu-id="5ae63-640">Stabilize, validate, and troubleshoot log shipping, as required.</span></span> <span data-ttu-id="5ae63-641">這包括識別及記錄可能造成問題的任何行為，例如網路延遲，這會導致記錄傳送或 DFSR 檔同步處理失敗。</span><span class="sxs-lookup"><span data-stu-id="5ae63-641">This included identifying and documenting any behavior that might cause issues, such as network latency, which would cause log shipping or DFSR file synchronization failures.</span></span>
    
### <a name="databases"></a><span data-ttu-id="5ae63-642">資料庫</span><span class="sxs-lookup"><span data-stu-id="5ae63-642">Databases</span></span>

<span data-ttu-id="5ae63-643">我們的容錯移轉測試包含下列資料庫：</span><span class="sxs-lookup"><span data-stu-id="5ae63-643">Our failover tests involved the following databases:</span></span> 
  
- <span data-ttu-id="5ae63-644">WSS_Content</span><span class="sxs-lookup"><span data-stu-id="5ae63-644">WSS_Content</span></span>
    
- <span data-ttu-id="5ae63-645">ManagedMetadata</span><span class="sxs-lookup"><span data-stu-id="5ae63-645">ManagedMetadata</span></span>
    
- <span data-ttu-id="5ae63-646">Profile DB</span><span class="sxs-lookup"><span data-stu-id="5ae63-646">Profile DB</span></span>
    
- <span data-ttu-id="5ae63-647">Sync DB</span><span class="sxs-lookup"><span data-stu-id="5ae63-647">Sync DB</span></span>
    
- <span data-ttu-id="5ae63-648">社交 DB</span><span class="sxs-lookup"><span data-stu-id="5ae63-648">Social DB</span></span>
    
- <span data-ttu-id="5ae63-649">內容類型中樞（專用內容類型整合中樞的資料庫）</span><span class="sxs-lookup"><span data-stu-id="5ae63-649">Content Type Hub (a database for a dedicated Content Type Syndication Hub)</span></span>
    
## <a name="troubleshooting-tips"></a><span data-ttu-id="5ae63-650">疑難排解提示</span><span class="sxs-lookup"><span data-stu-id="5ae63-650">Troubleshooting tips</span></span>

<span data-ttu-id="5ae63-651">本節說明我們在測試期間所遇到的問題，以及其解決方案。</span><span class="sxs-lookup"><span data-stu-id="5ae63-651">The section explains the problems we encountered during our testing and their solutions.</span></span> 
  
### <a name="using-the-term-store-management-tool-caused-the-error-the-managed-metadata-store-or-connection-is-currently-not-available"></a><span data-ttu-id="5ae63-652">使用術語存放區管理工具導致錯誤 "Managed Metadata Store 或 Connection 目前無法使用。</span><span class="sxs-lookup"><span data-stu-id="5ae63-652">Using the Term Store Management Tool caused the error, "The Managed Metadata Store or Connection is currently not available."</span></span>

<span data-ttu-id="5ae63-653">確定 web 應用程式使用的應用程式集區帳戶具有字詞存放區許可權的「讀取」許可權。</span><span class="sxs-lookup"><span data-stu-id="5ae63-653">Ensure that the application pool account used by the web application has the Read Access to Term Store permission.</span></span>
  
### <a name="custom-term-sets-are-not-available-in-the-site-collection"></a><span data-ttu-id="5ae63-654">無法在網站集合中使用自訂字詞集</span><span class="sxs-lookup"><span data-stu-id="5ae63-654">Custom term sets are not available in the site collection</span></span>

<span data-ttu-id="5ae63-655">檢查您的內容網站集合與內容類型中樞之間是否有遺失的服務應用程式關聯。</span><span class="sxs-lookup"><span data-stu-id="5ae63-655">Check for a missing service application association between your content site collection and your content type hub.</span></span> <span data-ttu-id="5ae63-656">此外，在 [**受管理的元 <site collection name> 資料-** 線上內容] 畫面底下，確定已啟用此選項：**此服務應用程式是欄特定字詞集的預設儲存位置。**</span><span class="sxs-lookup"><span data-stu-id="5ae63-656">In addition, under the **Managed Metadata - <site collection name> Connection** properties screen, make sure this option is enabled: **This service application is the default storage location for column specific term sets.**</span></span>
  
### <a name="the-get-adforest-windows-powershell-command-generates-the-error-the-term-get-adforest-is-not-recognized-as-the-name-of-a-cmdlet-function-script-file-or-operable-program"></a><span data-ttu-id="5ae63-657">ADForest Windows PowerShell 命令會產生錯誤，「字詞 ' ADForest ' 不會被辨識為 Cmdlet、function、script file 或可恢復程式的名稱。</span><span class="sxs-lookup"><span data-stu-id="5ae63-657">The Get-ADForest Windows PowerShell command generates the error, "The term 'Get-ADForest' is not recognized as the name of a cmdlet, function, script file, or operable program."</span></span>

<span data-ttu-id="5ae63-658">設定使用者設定檔時，您需要使用 Active Directory 樹系名稱。</span><span class="sxs-lookup"><span data-stu-id="5ae63-658">When setting up user profiles, you need the Active Directory forest name.</span></span> <span data-ttu-id="5ae63-659">在 [新增角色及功能] 嚮導中，確定已啟用 Windows PowerShell 的 Active Directory 模組（位於**遠端伺服器管理工具>>[AD DS 和 AD LDS 工具**] 區段中的 [遠端伺服器管理工具]）。</span><span class="sxs-lookup"><span data-stu-id="5ae63-659">In the Add Roles and Features Wizard, ensure that you have enabled the Active Directory Module for Windows PowerShell (under the **Remote Server Administration Tools>Role Administration Tools>AD DS and AD LDS Tools** section).</span></span> <span data-ttu-id="5ae63-660">此外，在使用**ADForest**之前，請先執行下列命令，以協助確保載入您的軟體相依性。</span><span class="sxs-lookup"><span data-stu-id="5ae63-660">In addition, run the following commands before using **Get-ADForest** to help ensure that your software dependencies are loaded.</span></span>
  
```
Import-module servermanager
Import-module activedirectory

```

### <a name="availability-group-creation-fails-at-starting-the-alwayson_health-xevent-session-on-server-name"></a><span data-ttu-id="5ae63-661">在 ' ' 上開始 ' AlwaysOn_health ' XEvent 會話」時，可用性群組建立失敗 <server name></span><span class="sxs-lookup"><span data-stu-id="5ae63-661">Availability group creation fails at Starting the 'AlwaysOn_health' XEvent session on '<server name>'</span></span>

<span data-ttu-id="5ae63-662">確定容錯移轉叢集的兩個節點都處於「Up」狀態，而不是「已暫停」或「已停止」。</span><span class="sxs-lookup"><span data-stu-id="5ae63-662">Ensure that both nodes of your failover cluster are in the Status "Up" and not "Paused" or "Stopped".</span></span> 
  
### <a name="sql-server-log-shipping-job-fails-with-access-denied-error-trying-to-connect-to-the-file-share"></a><span data-ttu-id="5ae63-663">嘗試連線至檔案共用時，SQL Server 記錄傳送工作失敗，存取權被拒絕</span><span class="sxs-lookup"><span data-stu-id="5ae63-663">SQL Server log shipping job fails with access denied error trying to connect to the file share</span></span>

<span data-ttu-id="5ae63-664">確定您的 SQL Server 代理程式是在 [網路認證] （而非預設認證）下執行。</span><span class="sxs-lookup"><span data-stu-id="5ae63-664">Ensure that your SQL Server Agent is running under network credentials, instead of the default credentials.</span></span>
  
### <a name="sql-server-log-shipping-job-indicates-success-but-no-files-are-copied"></a><span data-ttu-id="5ae63-665">SQL Server 記錄傳送工作會指出成功，但不會複製檔案</span><span class="sxs-lookup"><span data-stu-id="5ae63-665">SQL Server log shipping job indicates success, but no files are copied</span></span>

<span data-ttu-id="5ae63-666">發生這種情況是因為可用性群組的預設備份喜好設定**優先于第二**個。</span><span class="sxs-lookup"><span data-stu-id="5ae63-666">This happens because the default backup preference for an availability group is **Prefer Secondary**.</span></span> <span data-ttu-id="5ae63-667">確定您從可用性群組的次要伺服器（而非主要）執行記錄傳送工作。否則，工作將會以無訊息的方式失敗。</span><span class="sxs-lookup"><span data-stu-id="5ae63-667">Ensure that you run the log shipping job from the secondary server for the availability group instead of the primary; otherwise, the job will fail silently.</span></span> 
  
### <a name="managed-metadata-service-or-other-sharepoint-service-fails-to-start-automatically-after-installation"></a><span data-ttu-id="5ae63-668">無法在安裝之後自動啟動 Managed Metadata service （或其他 SharePoint 服務）</span><span class="sxs-lookup"><span data-stu-id="5ae63-668">Managed Metadata service (or other SharePoint service) fails to start automatically after installation</span></span>

<span data-ttu-id="5ae63-669">服務可能需要數分鐘的時間，視效能和目前負載的 SharePoint 伺服器而定。</span><span class="sxs-lookup"><span data-stu-id="5ae63-669">Services might take several minutes to start, depending on the performance and current load of your SharePoint Server.</span></span> <span data-ttu-id="5ae63-670">手動按一下服務的 [**啟動**]，並提供足夠的啟動時間，以偶爾重新整理伺服器畫面上的服務來監視其狀態。</span><span class="sxs-lookup"><span data-stu-id="5ae63-670">Manually click **Start** for the service and provide adequate time for startup while occasionally refreshing the Services on Server screen to monitor its status.</span></span> <span data-ttu-id="5ae63-671">若服務保持停止狀態，請啟用 SharePoint 診斷記錄，然後再次嘗試啟動服務，然後檢查記錄是否有錯誤。</span><span class="sxs-lookup"><span data-stu-id="5ae63-671">In case the service remains stopped, enable SharePoint diagnostic logging, attempt to start the service again, and then check the log for errors.</span></span> <span data-ttu-id="5ae63-672">如需詳細資訊，請參閱[Configure SharePoint 2013 中的診斷記錄](https://docs.microsoft.com/sharepoint/administration/configure-diagnostic-logging)</span><span class="sxs-lookup"><span data-stu-id="5ae63-672">For more information, see [Configure diagnostic logging in SharePoint 2013](https://docs.microsoft.com/sharepoint/administration/configure-diagnostic-logging)</span></span>
  
### <a name="after-changing-dns-to-the-azure-failover-environment-client-browsers-continue-to-use-the-old-ip-address-for-the-sharepoint-site"></a><span data-ttu-id="5ae63-673">將 DNS 變更為 Azure 容錯移轉環境之後，用戶端瀏覽器會繼續使用舊的 SharePoint 網站的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="5ae63-673">After changing DNS to the Azure failover environment, client browsers continue to use the old IP address for the SharePoint site</span></span>

<span data-ttu-id="5ae63-674">您的 DNS 變更可能不會立即對所有用戶端顯示。</span><span class="sxs-lookup"><span data-stu-id="5ae63-674">Your DNS change might not be visible to all clients immediately.</span></span> <span data-ttu-id="5ae63-675">在測試用戶端上，從提升許可權的命令提示字元中執行下列命令，然後再次嘗試存取網站。</span><span class="sxs-lookup"><span data-stu-id="5ae63-675">On a test client, perform the following command from an elevated command prompt and attempt to access the site again.</span></span>
  
```
Ipconfig /flushdns
```

## <a name="additional-resources"></a><span data-ttu-id="5ae63-676">其他資源</span><span class="sxs-lookup"><span data-stu-id="5ae63-676">Additional resources</span></span>

[<span data-ttu-id="5ae63-677">SharePoint 資料庫支援的高可用性和災害復原選項</span><span class="sxs-lookup"><span data-stu-id="5ae63-677">Supported high availability and disaster recovery options for SharePoint databases</span></span>](https://docs.microsoft.com/sharepoint/administration/supported-high-availability-and-disaster-recovery-options-for-sharepoint-databas)
  
[<span data-ttu-id="5ae63-678">設定 SharePoint 2013 的 SQL Server 2012 AlwaysOn 可用性群組</span><span class="sxs-lookup"><span data-stu-id="5ae63-678">Configure SQL Server 2012 AlwaysOn Availability Groups for SharePoint 2013</span></span>](https://go.microsoft.com/fwlink/p/?LinkId=393122)
  
## <a name="see-also"></a><span data-ttu-id="5ae63-679">另請參閱</span><span class="sxs-lookup"><span data-stu-id="5ae63-679">See Also</span></span>

[<span data-ttu-id="5ae63-680">雲端採用和混合式解決方案</span><span class="sxs-lookup"><span data-stu-id="5ae63-680">Cloud adoption and hybrid solutions</span></span>](cloud-adoption-and-hybrid-solutions.yml)



